<?php
/**
 * TVBox PHP 爬虫脚本 - 磁力增强版
 * 支持JSON/TXT/M3U/DB文件格式 + 磁力链接 + ed2k链接
 * 完整磁力文件夹扫描和智能命名功能
 * 增强调试功能 - 中文输出和文件日志
 */
ini_set('memory_limit', '-1');
// 获取请求参数
$操作类型 = $_GET['ac'] ?? 'detail';
$分类标识 = $_GET['t'] ?? '';
$页码 = $_GET['pg'] ?? '1';
$视频标识 = $_GET['ids'] ?? '';
$搜索关键词 = $_GET['wd'] ?? '';
$播放标志 = $_GET['flag'] ?? '';
$播放标识 = $_GET['id'] ?? '';

// 调试模式
$调试模式 = isset($_GET['debug']) ? true : false;

// 设置响应头为 JSON
header('Content-Type: application/json; charset=utf-8');

// 性能优化 - 增加超时时间
@set_time_limit(30);

// 创建调试日志
$调试日志 = [];
$调试日志['请求参数'] = [
    '操作类型' => $操作类型,
    '分类标识' => $分类标识,
    '页码' => $页码,
    '视频标识' => $视频标识,
    '搜索关键词' => $搜索关键词,
    '播放标志' => $播放标志,
    '播放标识' => $播放标识
];

// 初始化调试文件
初始化调试文件();

// 根据不同 action 返回数据
switch ($操作类型) {
    case 'detail':
        if (!empty($视频标识)) {
            $结果 = 获取详情($视频标识);
        } elseif (!empty($分类标识)) {
            $结果 = 获取分类($分类标识, $页码);
        } else {
            $结果 = 获取首页();
        }
        break;
    
    case 'search':
        $结果 = 搜索($搜索关键词, $页码);
        break;
        
    case 'play':
        $结果 = 获取播放($播放标志, $播放标识);
        break;
    
    default:
        $结果 = ['错误' => '未知操作: ' . $操作类型];
}

// 添加调试信息到响应
if ($调试模式) {
    $结果['_调试信息'] = $调试日志;
}

echo json_encode($结果, JSON_UNESCAPED_UNICODE);

/**
 * 初始化调试文件
 */
function 初始化调试文件() {
    $调试目录 = '/storage/emulated/0/江湖/debug/';
    if (!is_dir($调试目录)) {
        mkdir($调试目录, 0755, true);
        记录到文件('系统', "创建调试目录: {$调试目录}");
    }
    
    // 清空之前的调试文件
    $调试文件列表 = [
        $调试目录 . '调试文件.txt',
        $调试目录 . '数据库调试.txt', 
        $调试目录 . '播放日志.txt',
        $调试目录 . '文件扫描日志.txt'
    ];
    
    foreach ($调试文件列表 as $文件) {
        file_put_contents($文件, "=== 调试日志生成时间: " . date('Y-m-d H:i:s') . " ===\n\n", FILE_APPEND);
        记录到文件('系统', "初始化调试文件: {$文件}");
    }
}

/**
 * 记录调试信息到文件
 */
function 记录到文件($分类, $消息) {
    $调试目录 = '/storage/emulated/0/江湖/debug/';
    $时间戳 = date('Y-m-d H:i:s');
    
    $文件映射 = [
        '文件扫描' => '文件扫描日志.txt',
        '目录扫描' => '文件扫描日志.txt',
        '文件统计' => '文件扫描日志.txt',
        '数据库解析' => '数据库调试.txt',
        '数据库查询' => '数据库调试.txt',
        '数据库错误' => '数据库调试.txt',
        '数据库表结构' => '数据库调试.txt',
        '数据库字段识别' => '数据库调试.txt',
        '播放' => '播放日志.txt',
        '链接处理' => '播放日志.txt',
        '系统' => '调试文件.txt',
        '首页' => '调试文件.txt',
        '分类列表' => '调试文件.txt',
        '视频详情' => '调试文件.txt',
        '搜索' => '调试文件.txt',
        'JSON解析' => '调试文件.txt',
        'TXT解析' => '调试文件.txt',
        'M3U解析' => '调试文件.txt',
        '数量估算' => '调试文件.txt',
        '视频查找' => '调试文件.txt',
        '视频格式化' => '调试文件.txt',
        '详情格式化' => '调试文件.txt',
        '内存保护' => '调试文件.txt'
    ];
    
    $文件名 = $文件映射[$分类] ?? '调试文件.txt';
    $日志条目 = "[{$时间戳}] {$分类}: {$消息}\n";
    
    file_put_contents($调试目录 . $文件名, $日志条目, FILE_APPEND);
}

/**
 * 记录调试信息
 */
function 记录调试($分类, $消息, $数据 = null) {
    global $调试日志;
    if (!isset($调试日志[$分类])) {
        $调试日志[$分类] = [];
    }
    $调试日志[$分类][] = [
        '消息' => $消息,
        '数据' => $数据,
        '时间戳' => microtime(true)
    ];
    
    // 同时记录到文件
    $日志消息 = $消息;
    if ($数据 !== null) {
        $日志消息 .= " - 数据: " . (is_string($数据) ? $数据 : json_encode($数据, JSON_UNESCAPED_UNICODE));
    }
    记录到文件($分类, $日志消息);
}

/**
 * 递归扫描目录 - 支持无限级子文件夹
 */
function 递归扫描目录($目录, $文件类型, $当前深度 = 0, $最大深度 = 20) {
    记录调试('目录扫描', "开始扫描目录: {$目录}, 文件类型: " . implode(',', $文件类型) . ", 当前深度: {$当前深度}");
    
    $文件列表 = [];
    
    if (!is_dir($目录)) {
        记录调试('目录扫描', "目录不存在: {$目录}");
        return $文件列表;
    }
    
    if ($当前深度 > $最大深度) {
        记录调试('目录扫描', "达到最大扫描深度: {$当前深度}");
        return $文件列表;
    }
    
    $目录项 = @scandir($目录);
    if ($目录项 === false) {
        记录调试('目录扫描', "扫描目录失败: {$目录}");
        return $文件列表;
    }
    
    $文件数量 = 0;
    $目录数量 = 0;
    
    foreach ($目录项 as $项目) {
        if ($项目 === '.' || $项目 === '..') continue;
        
        $路径 = $目录 . $项目;
        
        if (is_dir($路径)) {
            $目录数量++;
            记录调试('目录扫描', "发现子目录: {$路径}");
            $子文件 = 递归扫描目录($路径 . '/', $文件类型, $当前深度 + 1, $最大深度);
            $文件列表 = array_merge($文件列表, $子文件);
        } else {
            $扩展名 = strtolower(pathinfo($路径, PATHINFO_EXTENSION));
            if (in_array($扩展名, $文件类型)) {
                $文件数量++;
                $相对路径 = str_replace('/storage/emulated/0/江湖/', '', $路径);
                
                // 检查是否为磁力文件夹
                $是磁力文件夹 = (strpos($路径, '/江湖/wj/bt/') !== false);
                
                $文件列表[] = [
                    'type' => $扩展名,
                    'path' => $路径,
                    'name' => $项目,
                    'filename' => pathinfo($项目, PATHINFO_FILENAME),
                    'relative_path' => $相对路径,
                    'depth' => $当前深度,
                    'is_magnet_folder' => $是磁力文件夹
                ];
                
                记录调试('文件扫描', "找到文件: {$项目}, 类型: {$扩展名}, 路径: {$相对路径}, 磁力文件夹: " . ($是磁力文件夹 ? '是' : '否'));
            }
        }
    }
    
    记录调试('目录扫描', "目录 {$目录} 扫描完成: 找到 {$文件数量} 个匹配文件, {$目录数量} 个子目录");
    
    return $文件列表;
}

/**
 * 获取所有文件列表 - 增强磁力文件夹支持
 */
function 获取所有文件() {
    static $所有文件 = null;
    
    if ($所有文件 === null) {
        记录调试('文件列表', "开始扫描所有媒体文件");
        $所有文件 = [];
        
        $JSON文件 = 递归扫描目录('/storage/emulated/0/江湖/json/影视/', ['json']);
        $TXT文件 = 递归扫描目录('/storage/emulated/0/江湖/wj/', ['txt']);
        $M3U文件 = array_merge(
            递归扫描目录('/storage/emulated/0/江湖/json/影视/', ['m3u']),
            递归扫描目录('/storage/emulated/0/江湖/wj/', ['m3u'])
        );
        
        // 增强数据库文件扫描，包含bt磁力文件夹
        $数据库文件 = array_merge(
            递归扫描目录('/storage/emulated/0/江湖/json/影视/', ['db']),
            递归扫描目录('/storage/emulated/0/江湖/wj/', ['db']),
            递归扫描目录('/storage/emulated/0/江湖/db/', ['db']),
            递归扫描目录('/storage/emulated/0/江湖/wj/bt/', ['db']) // 磁力文件夹的db文件
        );
        
        记录调试('文件统计', "各类文件数量统计: JSON=" . count($JSON文件) . "个, TXT=" . count($TXT文件) . "个, M3U=" . count($M3U文件) . "个, 数据库=" . count($数据库文件) . "个");
        
        $所有文件 = array_merge($JSON文件, $TXT文件, $M3U文件, $数据库文件);
        
        // 按路径排序
        usort($所有文件, function($甲, $乙) {
            return strcmp($甲['relative_path'], $乙['relative_path']);
        });
        
        记录调试('文件列表', "扫描完成，总共找到 " . count($所有文件) . " 个媒体文件");
        
        // 记录文件样本信息到调试文件
        $样本文件 = array_slice($所有文件, 0, min(10, count($所有文件)));
        foreach ($样本文件 as $索引 => $文件) {
            $磁力信息 = $文件['is_magnet_folder'] ? " [磁力文件夹]" : "";
            记录调试('文件样本', "文件{$索引}: {$文件['relative_path']} (类型: {$文件['type']}){$磁力信息}");
        }
        
        // 特别记录磁力文件夹文件
        $磁力文件 = array_filter($所有文件, function($文件) {
            return $文件['is_magnet_folder'];
        });
        记录调试('磁力文件', "找到 " . count($磁力文件) . " 个磁力文件夹文件");
        foreach ($磁力文件 as $磁力文件项) {
            记录调试('磁力文件详情', "磁力文件: {$磁力文件项['path']}, 类型: {$磁力文件项['type']}");
        }
    }
    
    return $所有文件;
}

/**
 * 估算文件中的视频数量（快速估算，不实际解析）
 */
function 估算文件视频数量($文件) {
    $路径 = $文件['path'];
    $类型 = $文件['type'];
    
    if (!file_exists($路径)) {
        记录调试('数量估算', "文件不存在: {$路径}");
        return 0;
    }
    
    $文件大小 = filesize($路径);
    记录调试('数量估算', "估算文件: {$路径}, 大小: {$文件大小} 字节, 类型: {$类型}");
    
    // 根据文件类型和大小快速估算
    switch ($类型) {
        case 'json':
            // JSON文件：假设平均每个视频占用1KB
            $数量 = $文件大小 > 1024 ? intval($文件大小 / 1024) : 1;
            break;
            
        case 'txt':
            // TXT文件：按行数估算（假设平均每行100字节）
            $行数 = $文件大小 > 100 ? intval($文件大小 / 100) : 1;
            $数量 = min($行数, 10000);
            break;
            
        case 'm3u':
            // M3U文件：每2行一个视频
            $行数 = $文件大小 > 200 ? intval($文件大小 / 200) : 1;
            $数量 = min($行数, 5000);
            break;
            
        case 'db':
            // DB文件：根据大小估算，假设平均每个视频记录占用500字节
            $数量 = $文件大小 > 500 ? intval($文件大小 / 500) : 1;
            break;
            
        default:
            $数量 = 0;
    }
    
    记录调试('数量估算', "文件 {$路径} 估算视频数量: {$数量}");
    return $数量;
}

/**
 * 获取分类列表
 */
function 获取分类列表() {
    static $分类列表 = null;
    
    if ($分类列表 === null) {
        记录调试('分类列表', "开始生成分类列表");
        $所有文件 = 获取所有文件();
        $分类列表 = [];
        
        // 新增热门推荐分类
        $总文件数 = count($所有文件);
        $分类列表[] = [
            'type_id' => 'hot',
            'type_name' => '🔥热门推荐 (' . $总文件数 . '个文件)',
            'type_file' => 'hot_recommend',
            'source_path' => 'hot',
            'source_type' => 'hot'
        ];
        
        记录调试('分类列表', "添加热门推荐分类，总文件数: {$总文件数}");
        
        // 用于去重的数组
        $已处理文件 = [];
        
        // 文件分类（显示所有文件）
        foreach ($所有文件 as $索引 => $文件) {
            // 去重：基于文件路径和名称
            $文件标识 = $文件['path'] . '|' . $文件['name'];
            if (in_array($文件标识, $已处理文件)) {
                记录调试('分类去重', "跳过重复文件: {$文件['path']}");
                continue;
            }
            $已处理文件[] = $文件标识;
            
            $文件类型 = '';
            $类型图标 = '';
            
            switch ($文件['type']) {
                case 'json':
                    $文件类型 = '[JSON] ';
                    $类型图标 = '📊 ';
                    break;
                case 'txt':
                    $文件类型 = '[TXT] ';
                    $类型图标 = '📄 ';
                    break;
                case 'm3u':
                    $文件类型 = '[M3U] ';
                    $类型图标 = '📺 ';
                    break;
                case 'db':
                    $文件类型 = '[数据库] ';
                    $类型图标 = '🗃️ ';
                    break;
            }
            
            // 磁力文件夹标识
            if ($文件['is_magnet_folder']) {
                $类型图标 = '🧲 ';
                $文件类型 = '[磁力] ';
            }
            
            // 显示文件夹路径
            $文件夹信息 = '';
            if (strpos($文件['relative_path'], '/') !== false) {
                $文件夹路径 = dirname($文件['relative_path']);
                $文件夹信息 = ' 📁 ' . $文件夹路径;
            }
            
            // 估算每个文件的视频数量
            $视频数量 = 估算文件视频数量($文件);
            $数量显示 = $视频数量 > 0 ? ' (' . number_format($视频数量) . '个视频)' : '';
            
            $分类列表[] = [
                'type_id' => (string)($索引 + 1),
                'type_name' => $类型图标 . $文件类型 . $文件['filename'] . $数量显示 . $文件夹信息,
                'type_file' => $文件['name'],
                'source_path' => $文件['path'],
                'source_type' => $文件['type'],
                'video_count' => $视频数量,
                'is_magnet_folder' => $文件['is_magnet_folder']
            ];
            
            记录调试('分类生成', "生成分类: {$类型图标}{$文件类型}{$文件['filename']}, 视频数量: {$视频数量}, 路径: {$文件['path']}");
        }
        
        if (empty($所有文件)) {
            记录调试('分类列表', "未找到任何媒体文件，添加空分类提示");
            $分类列表[] = [
                'type_id' => '1',
                'type_name' => '❓ 未找到媒体文件',
                'type_file' => 'empty',
                'source_path' => 'empty',
                'source_type' => 'empty'
            ];
        }
        
        记录调试('分类列表', "分类列表生成完成，共 " . count($分类列表) . " 个分类");
        
        // 调试：记录重复文件信息
        $重复检查 = [];
        foreach ($分类列表 as $分类) {
            $键值 = $分类['type_name'];
            if (isset($重复检查[$键值])) {
                记录调试('重复检查', "发现重复分类: {$键值}");
            }
            $重复检查[$键值] = true;
        }
    }
    
    return $分类列表;
}

/**
 * 解析SQLite数据库文件内容 - 增强磁力链接和JSON支持
 */
function 解析数据库文件($文件路径) {
    记录调试('数据库解析', "开始解析数据库文件: {$文件路径}");
    
    if (!file_exists($文件路径)) {
        记录调试('数据库解析', "数据库文件不存在: {$文件路径}");
        return ['错误' => '数据库文件不存在: ' . basename($文件路径)];
    }
    
    // 检查文件大小和权限
    $文件大小 = filesize($文件路径);
    $可读 = is_readable($文件路径);
    记录调试('数据库解析', "数据库文件信息 - 大小: {$文件大小} 字节, 可读: " . ($可读 ? '是' : '否'));
    
    if ($文件大小 === 0) {
        记录调试('数据库解析', "数据库文件为空: {$文件路径}");
        return ['错误' => '数据库文件为空: ' . basename($文件路径)];
    }
    
    if (!$可读) {
        记录调试('数据库解析', "数据库文件不可读: {$文件路径}");
        return ['错误' => '数据库文件不可读: ' . basename($文件路径)];
    }
    
    // 检查SQLite扩展
    if (!extension_loaded('pdo_sqlite')) {
        记录调试('数据库解析', "PDO_SQLite扩展不可用");
        return ['错误' => 'PDO_SQLite扩展不可用，无法读取数据库文件'];
    }
    
    try {
        // 创建数据库连接
        记录调试('数据库解析', "尝试连接数据库: {$文件路径}");
        $数据库 = new PDO("sqlite:" . $文件路径);
        $数据库->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        $视频列表 = [];
        
        // 尝试检测表结构并读取数据
        记录调试('数据库查询', "查询数据库表结构");
        $表列表 = $数据库->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
        
        记录调试('数据库解析', "数据库包含的表: " . implode(', ', $表列表));
        
        if (empty($表列表)) {
            记录调试('数据库解析', "数据库中未找到任何数据表");
            return ['错误' => '数据库中未找到任何数据表'];
        }
        
        $默认图片 = [
            'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg'
        ];
        
        foreach ($表列表 as $表名) {
            // 跳过系统表
            if (strpos($表名, 'sqlite_') === 0) continue;
            
            记录调试('数据库解析', "正在处理表: {$表名}");
            
            // 获取表结构
            $字段列表 = $数据库->query("PRAGMA table_info($表名)")->fetchAll(PDO::FETCH_ASSOC);
            $字段名称 = array_column($字段列表, 'name');
            
            记录调试('数据库表结构', "表 {$表名} 的字段: " . implode(', ', $字段名称));
            
            // 特殊处理：如果表有data字段，假设它包含JSON数据
            if (in_array('data', $字段名称)) {
                记录调试('数据库解析', "检测到data字段，尝试解析JSON数据");
                $结果集 = $数据库->query("SELECT data FROM $表名")->fetchAll(PDO::FETCH_COLUMN);
                
                foreach ($结果集 as $索引 => $json数据) {
                    if (empty($json数据)) continue;
                    
                    $视频数据 = json_decode($json数据, true);
                    if ($视频数据 && is_array($视频数据)) {
                        记录调试('JSON解析', "解析到JSON数据: " . json_encode($视频数据, JSON_UNESCAPED_UNICODE));
                        
                        // 从JSON数据中提取视频信息
                        $视频名称 = $视频数据['name'] ?? $视频数据['title'] ?? '未知视频';
                        $视频链接 = '';
                        $播放来源 = '数据库源';
                        
                        // 优先查找磁力链接
                        if (isset($视频数据['magnet']) && !empty($视频数据['magnet'])) {
                            $视频链接 = $视频数据['magnet'];
                            $播放来源 = '🧲磁力链接';
                        } elseif (isset($视频数据['magnet_url']) && !empty($视频数据['magnet_url'])) {
                            $视频链接 = $视频数据['magnet_url'];
                            $播放来源 = '🧲磁力链接';
                        } elseif (isset($视频数据['url']) && !empty($视频数据['url'])) {
                            $视频链接 = $视频数据['url'];
                            if (strpos($视频链接, 'magnet:') === 0) {
                                $播放来源 = '🧲磁力链接';
                            }
                        }
                        
                        // 如果没有有效的URL，跳过此记录
                        if (empty($视频链接)) {
                            记录调试('链接处理', "跳过记录 - 无有效URL: {$视频名称}");
                            continue;
                        }
                        
                        $视频封面 = $视频数据['cover'] ?? $视频数据['image'] ?? $视频数据['poster'] ?? $默认图片[$索引 % count($默认图片)];
                        $视频描述 = $视频数据['description'] ?? $视频数据['desc'] ?? $视频数据['content'] ?? '《' . $视频名称 . '》的精彩内容';
                        $视频年份 = $视频数据['year'] ?? date('Y');
                        $视频地区 = $视频数据['area'] ?? $视频数据['region'] ?? '未知地区';
                        
                        $视频列表[] = [
                            'vod_id' => 'db_' . md5($文件路径) . '_' . $表名 . '_' . $索引,
                            'vod_name' => $视频名称,
                            'vod_pic' => $视频封面,
                            'vod_remarks' => '高清',
                            'vod_year' => $视频年份,
                            'vod_area' => $视频地区,
                            'vod_content' => $视频描述,
                            'vod_play_from' => $播放来源,
                            'vod_play_url' => '正片$' . $视频链接
                        ];
                        
                        记录调试('视频添加', "成功添加视频: {$视频名称}, 来源: {$播放来源}");
                    }
                }
            } else {
                // 原有的字段识别逻辑（保持原有代码）
                $名称字段 = null;
                $链接字段 = null;
                $磁力字段 = null;
                $电驴字段 = null;
                $图片字段 = null;
                $描述字段 = null;
                $年份字段 = null;
                $地区字段 = null;
                $JSON字段 = null;
                
                foreach ($字段名称 as $字段) {
                    $小写字段 = strtolower($字段);
                    if (in_array($小写字段, ['name', 'title', 'vod_name', 'filename', 'video_name'])) {
                        $名称字段 = $字段;
                        记录调试('字段识别', "识别到名称字段: {$字段}");
                    } elseif (in_array($小写字段, ['url', 'link', 'vod_url', 'play_url', 'video_url', 'torrent'])) {
                        $链接字段 = $字段;
                        记录调试('字段识别', "识别到URL字段: {$字段}");
                    } elseif (in_array($小写字段, ['magnet', 'magnet_url', 'magnet_link'])) {
                        $磁力字段 = $字段;
                        记录调试('字段识别', "识别到磁力链接字段: {$字段}");
                    } elseif (in_array($小写字段, ['ed2k', 'ed2k_url', 'ed2k_link'])) {
                        $电驴字段 = $字段;
                        记录调试('字段识别', "识别到电驴链接字段: {$字段}");
                    } elseif (in_array($小写字段, ['pic', 'image', 'cover', 'vod_pic', 'poster'])) {
                        $图片字段 = $字段;
                        记录调试('字段识别', "识别到图片字段: {$字段}");
                    } elseif (in_array($小写字段, ['desc', 'description', 'content', 'vod_content'])) {
                        $描述字段 = $字段;
                        记录调试('字段识别', "识别到描述字段: {$字段}");
                    } elseif (in_array($小写字段, ['year', 'vod_year'])) {
                        $年份字段 = $字段;
                        记录调试('字段识别', "识别到年份字段: {$字段}");
                    } elseif (in_array($小写字段, ['area', 'region', 'vod_area'])) {
                        $地区字段 = $字段;
                        记录调试('字段识别', "识别到地区字段: {$字段}");
                    } elseif (in_array($小写字段, ['json', 'data', 'vod_data'])) {
                        $JSON字段 = $字段;
                        记录调试('字段识别', "识别到JSON数据字段: {$字段}");
                    }
                }
                
                // 如果有名称字段，则读取数据
                if ($名称字段) {
                    $选择字段 = [$名称字段];
                    if ($链接字段) $选择字段[] = $链接字段;
                    if ($磁力字段) $选择字段[] = $磁力字段;
                    if ($电驴字段) $选择字段[] = $电驴字段;
                    if ($图片字段) $选择字段[] = $图片字段;
                    if ($描述字段) $选择字段[] = $描述字段;
                    if ($年份字段) $选择字段[] = $年份字段;
                    if ($地区字段) $选择字段[] = $地区字段;
                    if ($JSON字段) $选择字段[] = $JSON字段;
                    
                    $查询SQL = "SELECT " . implode(', ', $选择字段) . " FROM $表名";
                    记录调试('数据库查询', "执行SQL查询: {$查询SQL}");
                    
                    $语句 = $数据库->query($查询SQL);
                    $结果集 = $语句->fetchAll(PDO::FETCH_ASSOC);
                    
                    记录调试('数据库查询', "表 {$表名} 查询到 " . count($结果集) . " 条记录");
                    
                    foreach ($结果集 as $索引 => $行数据) {
                        $视频名称 = $行数据[$名称字段] ?? '未知视频';
                        
                        // 处理JSON数据字段
                        if ($JSON字段 && !empty($行数据[$JSON字段])) {
                            $json数据 = json_decode($行数据[$JSON字段], true);
                            if ($json数据 && is_array($json数据)) {
                                记录调试('JSON解析', "解析到JSON数据: " . json_encode($json数据, JSON_UNESCAPED_UNICODE));
                                // 可以从JSON数据中提取更多信息
                                if (isset($json数据['name']) && empty($视频名称)) {
                                    $视频名称 = $json数据['name'];
                                }
                            }
                        }
                        
                        // 优先使用磁力链接，然后是ed2k，最后是普通URL
                        $视频链接 = '';
                        $播放来源 = '数据库源';
                        
                        if ($磁力字段 && !empty($行数据[$磁力字段])) {
                            $视频链接 = $行数据[$磁力字段];
                            $播放来源 = '🧲磁力链接';
                            记录调试('链接处理', "使用磁力链接: {$视频名称}");
                        } elseif ($电驴字段 && !empty($行数据[$电驴字段])) {
                            $视频链接 = $行数据[$电驴字段];
                            $播放来源 = '⚡电驴链接';
                            记录调试('链接处理', "使用电驴链接: {$视频名称}");
                        } elseif ($链接字段 && !empty($行数据[$链接字段])) {
                            $视频链接 = $行数据[$链接字段];
                            // 检查URL类型
                            if (strpos($视频链接, 'magnet:') === 0) {
                                $播放来源 = '🧲磁力链接';
                            } elseif (strpos($视频链接, 'ed2k://') === 0) {
                                $播放来源 = '⚡电驴链接';
                            }
                            记录调试('链接处理', "使用URL链接: {$视频名称}");
                        }
                        
                        // 如果没有任何有效的URL，跳过此记录
                        if (empty($视频链接)) {
                            记录调试('链接处理', "跳过记录 - 无有效URL: {$视频名称}");
                            continue;
                        }
                        
                        $视频封面 = $行数据[$图片字段] ?? $默认图片[$索引 % count($默认图片)];
                        $视频描述 = $行数据[$描述字段] ?? '《' . $视频名称 . '》的精彩内容';
                        $视频年份 = $行数据[$年份字段] ?? date('Y');
                        $视频地区 = $行数据[$地区字段] ?? '中国大陆';
                        
                        // 验证URL有效性 - 增强支持磁力和ed2k
                        $有效协议 = ['http://', 'https://', 'rtmp://', 'rtsp://', 'udp://', 'magnet:', 'ed2k://'];
                        $有有效协议 = false;
                        foreach ($有效协议 as $协议) {
                            if (stripos($视频链接, $协议) === 0) {
                                $有有效协议 = true;
                                break;
                            }
                        }
                        
                        if (!$有有效协议) {
                            记录调试('链接验证', "跳过记录 - 无效协议: {$视频链接}");
                            continue;
                        }
                        
                        $视频列表[] = [
                            'vod_id' => 'db_' . md5($文件路径) . '_' . $表名 . '_' . $索引,
                            'vod_name' => $视频名称,
                            'vod_pic' => $视频封面,
                            'vod_remarks' => '高清',
                            'vod_year' => $视频年份,
                            'vod_area' => $视频地区,
                            'vod_content' => $视频描述,
                            'vod_play_from' => $播放来源,
                            'vod_play_url' => '正片$' . $视频链接
                        ];
                        
                        记录调试('视频添加', "成功添加视频: {$视频名称}, 来源: {$播放来源}");
                        
                        // 内存保护
                        if (count($视频列表) >= 1000) {
                            记录调试('内存保护', "达到视频数量限制，停止解析");
                            break 2;
                        }
                    }
                } else {
                    记录调试('字段识别', "表 {$表名} 未识别到名称字段，跳过");
                }
            }
        }
        
        $数据库 = null; // 关闭连接
        
        记录调试('数据库解析', "数据库解析完成，共提取 " . count($视频列表) . " 个视频");
        
        return $视频列表;
        
    } catch (PDOException $异常) {
        记录调试('数据库错误', "数据库读取失败: " . $异常->getMessage());
        return ['错误' => '数据库读取失败: ' . $异常->getMessage()];
    }
}

/**
 * 解析JSON文件内容 - 完整加载
 */
function 解析JSON文件($文件路径) {
    记录调试('JSON解析', "开始解析JSON文件: {$文件路径}");
    
    if (!file_exists($文件路径)) {
        记录调试('JSON解析', "JSON文件不存在: {$文件路径}");
        return ['错误' => 'JSON文件不存在: ' . basename($文件路径)];
    }
    
    $文件大小 = filesize($文件路径);
    记录调试('JSON解析', "JSON文件大小: {$文件大小} 字节");
    
    $JSON内容 = @file_get_contents($文件路径);
    if ($JSON内容 === false) {
        记录调试('JSON解析', "无法读取JSON文件: {$文件路径}");
        return ['错误' => '无法读取JSON文件: ' . basename($文件路径)];
    }
    
    // 处理BOM头
    if (substr($JSON内容, 0, 3) == "\xEF\xBB\xBF") {
        $JSON内容 = substr($JSON内容, 3);
        记录调试('JSON解析', "已移除BOM头");
    }
    
    $数据 = json_decode($JSON内容, true);
    if (!$数据) {
        记录调试('JSON解析', "JSON格式无效: {$文件路径}");
        return ['错误' => 'JSON格式无效: ' . basename($文件路径)];
    }
    
    if (!isset($数据['list']) || !is_array($数据['list'])) {
        记录调试('JSON解析', "JSON缺少list字段或list不是数组: {$文件路径}");
        return ['错误' => 'JSON格式无效或缺少list字段: ' . basename($文件路径)];
    }
    
    记录调试('JSON解析', "JSON解析成功，找到 " . count($数据['list']) . " 个视频");
    
    return $数据['list'];
}

/**
 * 智能生成视频名称
 */
function 生成视频名称($链接, $默认名称 = '未知视频') {
    // 如果是磁力链接，尝试从链接中提取信息
    if (strpos($链接, 'magnet:?xt=urn:btih:') === 0) {
        // 尝试从dn参数获取名称
        if (preg_match('/&dn=([^&]+)/i', $链接, $匹配)) {
            $名称 = urldecode($匹配[1]);
            return $名称 ?: '磁力资源';
        }
        return '磁力资源';
    }
    
    // 如果是ed2k链接
    if (strpos($链接, 'ed2k://') === 0) {
        // 尝试从链接中提取文件名
        if (preg_match('/\|file\|([^\|]+)\|/i', $链接, $匹配)) {
            $名称 = urldecode($匹配[1]);
            return $名称 ?: '电驴资源';
        }
        return '电驴资源';
    }
    
    return $默认名称;
}

/**
 * 解析TXT文件内容 - 增强磁力链接和纯链接支持
 */
function 解析TXT文件($文件路径) {
    记录调试('TXT解析', "开始解析TXT文件: {$文件路径}");
    
    if (!file_exists($文件路径)) {
        记录调试('TXT解析', "TXT文件不存在: {$文件路径}");
        return ['错误' => 'TXT文件不存在: ' . basename($文件路径)];
    }
    
    $文件大小 = filesize($文件路径);
    记录调试('TXT解析', "TXT文件大小: {$文件大小} 字节");
    
    $句柄 = @fopen($文件路径, 'r');
    if (!$句柄) {
        记录调试('TXT解析', "无法打开TXT文件: {$文件路径}");
        return ['错误' => '无法打开TXT文件: ' . basename($文件路径)];
    }
    
    $视频列表 = [];
    $视频数量 = 0;
    $行号 = 0;
    $有效行数 = 0;
    
    $默认图片 = [
        'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg'
    ];
    
    // 检测BOM头
    $首行 = fgets($句柄);
    rewind($句柄);
    $有BOM = (substr($首行, 0, 3) == "\xEF\xBB\xBF");
    if ($有BOM) {
        fseek($句柄, 3);
        记录调试('TXT解析', "检测到BOM头，已跳过");
    }
    
    $内存限制 = 50 * 1024 * 1024;
    $起始内存 = memory_get_usage();
    
    while (($行 = fgets($句柄)) !== false) {
        $行号++;
        $行 = trim($行);
        
        if ($行 === '' || $行[0] === '#' || $行[0] === ';') {
            continue;
        }
        
        // 增强纯链接支持：直接检测磁力链接和ed2k链接
        if (strpos($行, 'magnet:') === 0 || strpos($行, 'ed2k://') === 0) {
            $链接 = $行;
            $名称 = 生成视频名称($链接);
            
            记录调试('TXT解析', "第 {$行号} 行: 纯链接 - {$名称}");
        } else {
            // 传统分隔符解析
            $分隔符 = [',', "\t", '|', '$', '#'];
            $分隔符位置 = false;
            
            foreach ($分隔符 as $分隔) {
                $位置 = strpos($行, $分隔);
                if ($位置 !== false) {
                    $分隔符位置 = $位置;
                    break;
                }
            }
            
            if ($分隔符位置 === false) {
                记录调试('TXT解析', "第 {$行号} 行未找到分隔符，尝试作为纯链接: {$行}");
                // 尝试作为纯链接处理
                $链接 = $行;
                $名称 = 生成视频名称($链接);
            } else {
                $名称 = trim(substr($行, 0, $分隔符位置));
                $链接 = trim(substr($行, $分隔符位置 + 1));
            }
        }
        
        if (empty($名称) || empty($链接)) {
            记录调试('TXT解析', "第 {$行号} 行名称或URL为空");
            continue;
        }
        
        // 增强协议支持：包含磁力链接和ed2k
        $有效协议 = ['http://', 'https://', 'rtmp://', 'rtsp://', 'udp://', 'magnet:', 'ed2k://'];
        $有有效协议 = false;
        foreach ($有效协议 as $协议) {
            if (stripos($链接, $协议) === 0) {
                $有有效协议 = true;
                break;
            }
        }
        
        if (!$有有效协议) {
            记录调试('TXT解析', "第 {$行号} 行URL协议无效: {$链接}");
            continue;
        }
        
        $图片索引 = $视频数量 % count($默认图片);
        
        // 确定播放来源
        $播放来源 = '在线播放';
        if (strpos($链接, 'magnet:') === 0) {
            $播放来源 = '🧲磁力链接';
        } elseif (strpos($链接, 'ed2k://') === 0) {
            $播放来源 = '⚡电驴链接';
        }
        
        $视频列表[] = [
            'vod_id' => 'txt_' . md5($文件路径) . '_' . $行号,
            'vod_name' => $名称,
            'vod_pic' => $默认图片[$图片索引],
            'vod_remarks' => '高清',
            'vod_year' => date('Y'),
            'vod_area' => '中国大陆',
            'vod_content' => '《' . $名称 . '》的精彩内容',
            'vod_play_from' => $播放来源,
            'vod_play_url' => '正片$' . $链接
        ];
        
        $视频数量++;
        $有效行数++;
        
        记录调试('TXT解析', "第 {$行号} 行解析成功: {$名称} -> {$播放来源}");

        // 内存保护
        if ($视频数量 % 100 === 0) {
            $当前内存 = memory_get_usage() - $起始内存;
            if ($当前内存 > $内存限制) {
                记录调试('内存保护', "达到内存限制，停止解析");
                break;
            }
            gc_collect_cycles();
        }
        
        if ($视频数量 >= 10000) {
            记录调试('数量限制', "达到视频数量限制，停止解析");
            break;
        }
    }
    
    fclose($句柄);
    
    记录调试('TXT解析', "TXT文件解析完成: 总行数 {$行号}, 有效视频 {$有效行数} 个");
    
    return $视频列表;
}

/**
 * 解析M3U文件内容 - 增强磁力链接支持
 */
function 解析M3U文件($文件路径) {
    记录调试('M3U解析', "开始解析M3U文件: {$文件路径}");
    
    if (!file_exists($文件路径)) {
        记录调试('M3U解析', "M3U文件不存在: {$文件路径}");
        return ['错误' => 'M3U文件不存在: ' . basename($文件路径)];
    }
    
    $文件大小 = filesize($文件路径);
    记录调试('M3U解析', "M3U文件大小: {$文件大小} 字节");
    
    $句柄 = @fopen($文件路径, 'r');
    if (!$句柄) {
        记录调试('M3U解析', "无法打开M3U文件: {$文件路径}");
        return ['错误' => '无法打开M3U文件: ' . basename($文件路径)];
    }
    
    $视频列表 = [];
    $视频数量 = 0;
    $当前名称 = '';
    $当前图标 = '';
    $当前分组 = '';
    $行号 = 0;
    
    $默认图片 = [
        'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg'
    ];
    
    // 检测BOM头
    $首行 = fgets($句柄);
    rewind($句柄);
    $有BOM = (substr($首行, 0, 3) == "\xEF\xBB\xBF");
    if ($有BOM) {
        fseek($句柄, 3);
        记录调试('M3U解析', "检测到BOM头，已跳过");
    }
    
    while (($行 = fgets($句柄)) !== false) {
        $行号++;
        $行 = trim($行);
        if ($行 === '') continue;
        
        if (strpos($行, '#EXTM3U') === 0) {
            记录调试('M3U解析', "第 {$行号} 行: M3U文件头");
            continue;
        }
        
        if (strpos($行, '#EXTINF:') === 0) {
            $当前名称 = '';
            $当前图标 = '';
            $当前分组 = '';
            
            $部分 = explode(',', $行, 2);
            if (count($部分) > 1) {
                $当前名称 = trim($部分[1]);
            }
            
            if (preg_match('/tvg-logo="([^"]*)"/i', $行, $图标匹配)) {
                $当前图标 = trim($图标匹配[1]);
            }
            
            if (preg_match('/group-title="([^"]*)"/i', $行, $分组匹配)) {
                $当前分组 = trim($分组匹配[1]);
            }
            
            记录调试('M3U解析', "第 {$行号} 行: EXTINF信息 - 名称: {$当前名称}, 台标: {$当前图标}, 分组: {$当前分组}");
            continue;
        }
        
        // 修复：增强链接类型支持和验证逻辑
        $有效协议 = ['http://', 'https://', 'rtmp://', 'rtsp://', 'udp://', 'magnet:', 'ed2k://'];
        $有有效协议 = false;
        foreach ($有效协议 as $协议) {
            if (stripos($行, $协议) === 0) {
                $有有效协议 = true;
                break;
            }
        }
        
        if ($有有效协议 && !empty($当前名称)) {
            $图片索引 = $视频数量 % count($默认图片);
            
            $视频封面 = $当前图标;
            if (empty($视频封面) || !filter_var($视频封面, FILTER_VALIDATE_URL)) {
                $视频封面 = $默认图片[$图片索引];
            }
            
            $播放来源 = '直播源';
            if (!empty($当前分组)) {
                $播放来源 = $当前分组;
            }
            
            // 确定播放来源
            if (strpos($行, 'magnet:') === 0) {
                $播放来源 = '🧲磁力链接';
            } elseif (strpos($行, 'ed2k://') === 0) {
                $播放来源 = '⚡电驴链接';
            }
            
            $视频列表[] = [
                'vod_id' => 'm3u_' . md5($文件路径) . '_' . $行号, // 使用行号作为唯一标识
                'vod_name' => $当前名称,
                'vod_pic' => $视频封面,
                'vod_remarks' => '直播',
                'vod_year' => date('Y'),
                'vod_area' => '中国大陆',
                'vod_content' => $当前名称 . '直播频道',
                'vod_play_from' => $播放来源,
                'vod_play_url' => '直播$' . $行
            ];
            
            记录调试('M3U解析', "第 {$行号} 行: 添加视频 - 名称: {$当前名称}, 来源: {$播放来源}");
            
            $视频数量++;
            
            // 重置当前变量，为下一个条目准备
            $当前名称 = '';
            $当前图标 = '';
            $当前分组 = '';
            
            if ($视频数量 >= 5000) {
                记录调试('M3U解析', "达到视频数量限制，停止解析");
                break;
            }
        } else {
            // 记录调试信息，帮助诊断问题
            if (empty($当前名称)) {
                记录调试('M3U解析', "第 {$行号} 行: 跳过 - 缺少名称, URL: " . substr($行, 0, 50) . "...");
            } elseif (!$有有效协议) {
                记录调试('M3U解析', "第 {$行号} 行: 跳过 - 无效协议, URL: " . substr($行, 0, 50) . "...");
            }
        }
    }
    
    fclose($句柄);
    
    记录调试('M3U解析', "M3U文件解析完成: 总行数 {$行号}, 有效视频 {$视频数量} 个");
    
    return $视频列表;
}

/**
 * 获取热门推荐视频 - 从所有分类中随机获取
 */
function 获取热门视频($页码, $每页数量 = 10) {
    记录调试('热门推荐', "开始获取热门推荐视频，页码: {$页码}, 每页: {$每页数量}");
    
    static $所有热门视频 = null;
    static $已使用视频标识 = [];
    
    // 如果是第一页，重新生成随机视频
    if ($页码 == 1) {
        $已使用视频标识 = [];
        记录调试('热门推荐', "第一页，重置已使用视频ID");
    }
    
    // 收集所有文件的视频
    if ($所有热门视频 === null) {
        记录调试('热门推荐', "开始收集所有文件的视频");
        $所有热门视频 = [];
        $所有文件 = 获取所有文件();
        
        foreach ($所有文件 as $文件) {
            if (!file_exists($文件['path'])) {
                记录调试('热门推荐', "文件不存在，跳过: {$文件['path']}");
                continue;
            }
            
            $视频列表 = [];
            switch ($文件['type']) {
                case 'json':
                    $视频列表 = 解析JSON文件($文件['path']);
                    break;
                case 'txt':
                    $视频列表 = 解析TXT文件($文件['path']);
                    break;
                case 'm3u':
                    $视频列表 = 解析M3U文件($文件['path']);
                    break;
                case 'db':
                    $视频列表 = 解析数据库文件($文件['path']);
                    break;
            }
            
            // 如果是错误信息，跳过
            if (isset($视频列表['错误'])) {
                记录调试('热门推荐', "文件解析错误: {$文件['path']} - {$视频列表['错误']}");
                continue;
            }
            
            // 限制每个文件的视频数量，避免内存问题
            if (count($视频列表) > 100) {
                $视频列表 = array_slice($视频列表, 0, 100);
                记录调试('热门推荐', "限制文件视频数量: {$文件['path']} -> 100");
            }
            
            $所有热门视频 = array_merge($所有热门视频, $视频列表);
            记录调试('热门推荐', "文件 {$文件['path']} 添加了 " . count($视频列表) . " 个视频，总计: " . count($所有热门视频));
            
            // 内存保护
            if (count($所有热门视频) > 1000) {
                记录调试('热门推荐', "达到热门视频数量限制，停止收集");
                break;
            }
        }
        
        记录调试('热门推荐', "热门视频收集完成，总计: " . count($所有热门视频) . " 个视频");
    }
    
    if (empty($所有热门视频)) {
        记录调试('热门推荐', "没有可用的热门视频");
        return [];
    }
    
    // 过滤掉已经使用过的视频
    $可用视频 = [];
    foreach ($所有热门视频 as $视频) {
        $视频标识 = $视频['vod_id'] ?? '';
        if (!in_array($视频标识, $已使用视频标识)) {
            $可用视频[] = $视频;
        }
    }
    
    记录调试('热门推荐', "可用视频: " . count($可用视频) . " 个，已使用: " . count($已使用视频标识) . " 个");
    
    // 如果可用视频不足，重新开始（实现无限翻页）
    if (empty($可用视频)) {
        记录调试('热门推荐', "可用视频不足，重置已使用视频ID");
        $已使用视频标识 = [];
        $可用视频 = $所有热门视频;
    }
    
    // 随机选择视频
    $选中视频 = [];
    $需要数量 = min($每页数量, count($可用视频));
    
    if ($需要数量 > 0) {
        $随机键 = array_rand($可用视频, $需要数量);
        if (!is_array($随机键)) {
            $随机键 = [$随机键];
        }
        
        foreach ($随机键 as $键) {
            $选中视频项 = $可用视频[$键];
            $选中视频[] = $选中视频项;
            $已使用视频标识[] = $选中视频项['vod_id'] ?? '';
        }
        
        记录调试('热门推荐', "随机选择了 {$需要数量} 个视频");
    }
    
    记录调试('热门推荐', "返回热门视频: " . count($选中视频) . " 个");
    
    return $选中视频;
}

/**
 * 首页数据
 */
function 获取首页() {
    记录调试('首页', "开始获取首页数据");
    
    $分类列表 = 获取分类列表();
    
    if (empty($分类列表)) {
        记录调试('首页', "未找到任何分类");
        return ['错误' => '未找到任何文件'];
    }
    
    记录调试('首页', "首页数据获取完成，分类数量: " . count($分类列表));
    
    return [
        'class' => $分类列表
    ];
}

/**
 * 分类列表
 */
function 获取分类($分类标识, $页码) {
    记录调试('分类列表', "开始获取分类内容，分类标识: {$分类标识}, 页码: {$页码}");
    
    $分类列表 = 获取分类列表();
    
    if (empty($分类列表)) {
        记录调试('分类列表', "未找到任何分类");
        return ['错误' => '未找到任何分类'];
    }
    
    // 热门推荐分类处理
    if ($分类标识 === 'hot') {
        记录调试('分类列表', "处理热门推荐分类");
        $当前页码 = intval($页码);
        if ($当前页码 < 1) $当前页码 = 1;
        
        $热门视频 = 获取热门视频($当前页码, 10);
        
        if (empty($热门视频)) {
            记录调试('分类列表', "热门推荐没有视频");
            return [
                'page' => $当前页码,
                'pagecount' => 9999, // 支持无限翻页
                'limit' => 10,
                'total' => 0,
                'list' => []
            ];
        }
        
        $格式化视频 = [];
        foreach ($热门视频 as $视频) {
            $格式化视频[] = 格式化视频项($视频);
        }
        
        记录调试('分类列表', "热门推荐返回 " . count($格式化视频) . " 个视频");
        
        return [
            'page' => $当前页码,
            'pagecount' => 9999, // 支持无限翻页
            'limit' => 10,
            'total' => 999999, // 大数字表示无限内容
            'list' => $格式化视频
        ];
    }
    
    // 找到对应的文件分类
    $目标分类 = null;
    foreach ($分类列表 as $分类) {
        if ($分类['type_id'] === $分类标识) {
            $目标分类 = $分类;
            break;
        }
    }
    
    if (!$目标分类) {
        记录调试('分类列表', "分类未找到: {$分类标识}");
        return ['错误' => '分类未找到: ' . $分类标识];
    }
    
    记录调试('分类列表', "找到分类: {$目标分类['type_name']}, 源文件: {$目标分类['source_path']}, 类型: {$目标分类['source_type']}, 磁力文件夹: " . ($目标分类['is_magnet_folder'] ? '是' : '否'));
    
    if ($目标分类['source_type'] === 'empty') {
        记录调试('分类列表', "分类为空分类");
        return [
            'page' => 1,
            'pagecount' => 1,
            'limit' => 10,
            'total' => 0,
            'list' => []
        ];
    }
    
    // 文件分类：一次性加载完整内容
    $分类视频 = [];
    
    if (file_exists($目标分类['source_path'])) {
        记录调试('分类列表', "开始解析文件: {$目标分类['source_path']}, 类型: {$目标分类['source_type']}");
        
        switch ($目标分类['source_type']) {
            case 'json':
                $分类视频 = 解析JSON文件($目标分类['source_path']);
                break;
            case 'txt':
                $分类视频 = 解析TXT文件($目标分类['source_path']);
                break;
            case 'm3u':
                $分类视频 = 解析M3U文件($目标分类['source_path']);
                break;
            case 'db':
                $分类视频 = 解析数据库文件($目标分类['source_path']);
                break;
        }
        
        记录调试('分类列表', "文件解析完成，获取到 " . count($分类视频) . " 个视频");
    } else {
        记录调试('分类列表', "源文件不存在: {$目标分类['source_path']}");
    }
    
    // 检查是否是错误信息
    if (isset($分类视频['错误'])) {
        记录调试('分类列表', "文件解析错误: {$分类视频['错误']}");
        return ['错误' => $分类视频['错误']];
    }
    
    if (empty($分类视频)) {
        记录调试('分类列表', "文件中未找到视频: {$目标分类['type_name']}");
        return ['错误' => '在文件中未找到视频: ' . $目标分类['type_name']];
    }
    
    // 分页处理
    $每页大小 = 10;
    $总数 = count($分类视频);
    $总页数 = ceil($总数 / $每页大小);
    $当前页码 = intval($页码);
    
    if ($当前页码 < 1) $当前页码 = 1;
    if ($当前页码 > $总页数) $当前页码 = $总页数;
    
    $起始位置 = ($当前页码 - 1) * $每页大小;
    $分页视频 = array_slice($分类视频, $起始位置, $每页大小);
    
    $格式化视频 = [];
    foreach ($分页视频 as $视频) {
        $格式化视频[] = 格式化视频项($视频);
    }
    
    记录调试('分类列表', "分页结果: 第 {$当前页码}/{$总页数} 页, 显示 " . count($格式化视频) . " 个视频");
    
    return [
        'page' => $当前页码,
        'pagecount' => $总页数,
        'limit' => $每页大小,
        'total' => $总数,
        'list' => $格式化视频
    ];
}

/**
 * 格式化视频项
 */
function 格式化视频项($视频) {
    $格式化 = [
        'vod_id' => $视频['vod_id'] ?? '',
        'vod_name' => $视频['vod_name'] ?? '未知视频',
        'vod_pic' => $视频['vod_pic'] ?? 'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg',
        'vod_remarks' => $视频['vod_remarks'] ?? '高清',
        'vod_year' => $视频['vod_year'] ?? '',
        'vod_area' => $视频['vod_area'] ?? '中国大陆'
    ];
    
    记录调试('视频格式化', "格式化视频: {$格式化['vod_name']}");
    
    return $格式化;
}

/**
 * 视频详情
 */
function 获取详情($视频标识) {
    记录调试('视频详情', "开始获取视频详情，标识: {$视频标识}");
    
    $标识数组 = explode(',', $视频标识);
    $结果 = [];
    
    foreach ($标识数组 as $标识) {
        记录调试('视频详情', "查找视频标识: {$标识}");
        $视频 = 按标识查找视频($标识);
        if ($视频) {
            记录调试('视频详情', "找到视频: {$视频['vod_name']}");
            $结果[] = 格式化视频详情($视频);
        } else {
            记录调试('视频详情', "未找到视频，使用默认信息");
            $结果[] = [
                'vod_id' => $标识,
                'vod_name' => '视频 ' . $标识,
                'vod_pic' => 'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg',
                'vod_remarks' => '高清',
                'vod_content' => '视频详情内容',
                'vod_play_from' => '在线播放',
                'vod_play_url' => '正片$https://example.com/video'
            ];
        }
    }
    
    记录调试('视频详情', "返回详情数量: " . count($结果));
    
    return ['list' => $结果];
}

/**
 * 按标识查找视频
 */
function 按标识查找视频($标识) {
    记录调试('视频查找', "按标识查找视频: {$标识}");
    
    $所有文件 = 获取所有文件();
    
    if (strpos($标识, 'txt_') === 0) {
        记录调试('视频查找', "TXT类型视频标识");
        $部分 = explode('_', $标识);
        if (count($部分) >= 3) {
            $文件哈希 = $部分[1];
            $行号 = $部分[2];
            
            foreach ($所有文件 as $文件) {
                if ($文件['type'] === 'txt' && md5($文件['path']) === $文件哈希) {
                    记录调试('视频查找', "找到TXT文件: {$文件['path']}, 行号: {$行号}");
                    return 按行查找TXT视频($文件['path'], $行号);
                }
            }
        }
    } elseif (strpos($标识, 'm3u_') === 0) {
        记录调试('视频查找', "M3U类型视频标识");
        $部分 = explode('_', $标识);
        if (count($部分) >= 3) {
            $文件哈希 = $部分[1];
            $行号 = $部分[2];
            
            foreach ($所有文件 as $文件) {
                if ($文件['type'] === 'm3u' && md5($文件['path']) === $文件哈希) {
                    记录调试('视频查找', "找到M3U文件: {$文件['path']}, 行号: {$行号}");
                    return 按行查找M3U视频($文件['path'], $行号);
                }
            }
        }
    } elseif (strpos($标识, 'db_') === 0) {
        记录调试('视频查找', "数据库类型视频标识");
        $部分 = explode('_', $标识);
        if (count($部分) >= 4) {
            $文件哈希 = $部分[1];
            $表名 = $部分[2];
            $视频索引 = $部分[3];
            
            foreach ($所有文件 as $文件) {
                if ($文件['type'] === 'db' && md5($文件['path']) === $文件哈希) {
                    记录调试('视频查找', "找到数据库文件: {$文件['path']}, 表: {$表名}, 索引: {$视频索引}");
                    return 按索引查找数据库视频($文件['path'], $表名, $视频索引);
                }
            }
        }
    } else {
        记录调试('视频查找', "JSON类型视频标识");
        foreach ($所有文件 as $文件) {
            if ($文件['type'] === 'json') {
                $视频列表 = 解析JSON文件($文件['path']);
                foreach ($视频列表 as $视频) {
                    if (isset($视频['vod_id']) && $视频['vod_id'] == $标识) {
                        记录调试('视频查找', "在JSON文件中找到视频: {$视频['vod_name']}");
                        return $视频;
                    }
                }
            }
        }
    }
    
    记录调试('视频查找', "未找到视频: {$标识}");
    return null;
}

/**
 * 在TXT文件中按行号查找视频 - 增强磁力链接支持
 */
function 按行查找TXT视频($文件路径, $目标行号) {
    记录调试('TXT查找', "在TXT文件中查找视频，文件: {$文件路径}, 行号: {$目标行号}");
    
    if (!file_exists($文件路径)) {
        记录调试('TXT查找', "文件不存在: {$文件路径}");
        return null;
    }
    
    $句柄 = @fopen($文件路径, 'r');
    if (!$句柄) {
        记录调试('TXT查找', "无法打开文件: {$文件路径}");
        return null;
    }
    
    $当前行 = 0;
    $视频 = null;
    
    $默认图片 = [
        'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg'
    ];
    
    // 检测BOM头
    $首行 = fgets($句柄);
    rewind($句柄);
    $有BOM = (substr($首行, 0, 3) == "\xEF\xBB\xBF");
    if ($有BOM) {
        fseek($句柄, 3);
        记录调试('TXT查找', "检测到BOM头，已跳过");
    }
    
    while (($行 = fgets($句柄)) !== false) {
        $当前行++;
        $行 = trim($行);
        
        if ($行 === '' || $行[0] === '#' || $行[0] === ';') continue;
        
        if ($当前行 == $目标行号) {
            记录调试('TXT查找', "找到目标行: {$当前行}, 内容: {$行}");
            
            // 增强纯链接支持
            if (strpos($行, 'magnet:') === 0 || strpos($行, 'ed2k://') === 0) {
                $链接 = $行;
                $名称 = 生成视频名称($链接);
            } else {
                $分隔符 = [',', "\t", '|', '$', '#'];
                $分隔符位置 = false;
                
                foreach ($分隔符 as $分隔) {
                    $位置 = strpos($行, $分隔);
                    if ($位置 !== false) {
                        $分隔符位置 = $位置;
                        break;
                    }
                }
                
                if ($分隔符位置 !== false) {
                    $名称 = trim(substr($行, 0, $分隔符位置));
                    $链接 = trim(substr($行, $分隔符位置 + 1));
                } else {
                    // 尝试作为纯链接处理
                    $链接 = $行;
                    $名称 = 生成视频名称($链接);
                }
            }
            
            if (!empty($名称) && !empty($链接)) {
                $图片索引 = $当前行 % count($默认图片);
                
                // 确定播放来源
                $播放来源 = '在线播放';
                if (strpos($链接, 'magnet:') === 0) {
                    $播放来源 = '🧲磁力链接';
                } elseif (strpos($链接, 'ed2k://') === 0) {
                    $播放来源 = '⚡电驴链接';
                }
                
                $视频 = [
                    'vod_id' => 'txt_' . md5($文件路径) . '_' . $当前行,
                    'vod_name' => $名称,
                    'vod_pic' => $默认图片[$图片索引],
                    'vod_remarks' => '高清',
                    'vod_year' => date('Y'),
                    'vod_area' => '中国大陆',
                    'vod_content' => '《' . $名称 . '》的精彩内容',
                    'vod_play_from' => $播放来源,
                    'vod_play_url' => '正片$' . $链接
                ];
                
                记录调试('TXT查找', "成功创建视频信息: {$名称}");
            } else {
                记录调试('TXT查找', "名称或URL为空: 名称='{$名称}', URL='{$链接}'");
            }
            break;
        }
    }
    
    fclose($句柄);
    
    if ($视频) {
        记录调试('TXT查找', "成功找到视频");
    } else {
        记录调试('TXT查找', "未找到视频");
    }
    
    return $视频;
}

/**
 * 在M3U文件中按行号查找视频
 */
function 按行查找M3U视频($文件路径, $目标行号) {
    记录调试('M3U查找', "在M3U文件中查找视频，文件: {$文件路径}, 行号: {$目标行号}");
    
    if (!file_exists($文件路径)) {
        记录调试('M3U查找', "文件不存在: {$文件路径}");
        return null;
    }
    
    $句柄 = @fopen($文件路径, 'r');
    if (!$句柄) {
        记录调试('M3U查找', "无法打开文件: {$文件路径}");
        return null;
    }
    
    $当前行 = 0;
    $视频 = null;
    $当前名称 = '';
    $当前图标 = '';
    $当前分组 = '';
    
    $默认图片 = [
        'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg'
    ];
    
    // 检测BOM头
    $首行 = fgets($句柄);
    rewind($句柄);
    $有BOM = (substr($首行, 0, 3) == "\xEF\xBB\xBF");
    if ($有BOM) {
        fseek($句柄, 3);
        记录调试('M3U查找', "检测到BOM头，已跳过");
    }
    
    while (($行 = fgets($句柄)) !== false) {
        $当前行++;
        $行 = trim($行);
        if ($行 === '') continue;
        
        if (strpos($行, '#EXTM3U') === 0) {
            continue;
        }
        
        if (strpos($行, '#EXTINF:') === 0) {
            $当前名称 = '';
            $当前图标 = '';
            $当前分组 = '';
            
            $部分 = explode(',', $行, 2);
            if (count($部分) > 1) {
                $当前名称 = trim($部分[1]);
            }
            
            if (preg_match('/tvg-logo="([^"]*)"/i', $行, $图标匹配)) {
                $当前图标 = trim($图标匹配[1]);
            }
            
            if (preg_match('/group-title="([^"]*)"/i', $行, $分组匹配)) {
                $当前分组 = trim($分组匹配[1]);
            }
            
            记录调试('M3U查找', "第 {$当前行} 行: EXTINF信息 - 名称: {$当前名称}");
            continue;
        }
        
        if ((strpos($行, 'http') === 0 || strpos($行, 'rtmp') === 0 || 
             strpos($行, 'rtsp') === 0 || strpos($行, 'udp') === 0 ||
             strpos($行, 'magnet:') === 0 || strpos($行, 'ed2k://') === 0) && 
            !empty($当前名称)) {
            
            if ($当前行 == $目标行号) {
                记录调试('M3U查找', "找到目标行: {$当前行}, 名称: {$当前名称}, URL: " . substr($行, 0, 50) . "...");
                
                $图片索引 = $当前行 % count($默认图片);
                
                $视频封面 = $当前图标;
                if (empty($视频封面) || !filter_var($视频封面, FILTER_VALIDATE_URL)) {
                    $视频封面 = $默认图片[$图片索引];
                }
                
                $播放来源 = '直播源';
                if (!empty($当前分组)) {
                    $播放来源 = $当前分组;
                }
                
                // 确定播放来源
                if (strpos($行, 'magnet:') === 0) {
                    $播放来源 = '🧲磁力链接';
                } elseif (strpos($行, 'ed2k://') === 0) {
                    $播放来源 = '⚡电驴链接';
                }
                
                $视频 = [
                    'vod_id' => 'm3u_' . md5($文件路径) . '_' . $当前行,
                    'vod_name' => $当前名称,
                    'vod_pic' => $视频封面,
                    'vod_remarks' => '直播',
                    'vod_year' => date('Y'),
                    'vod_area' => '中国大陆',
                    'vod_content' => $当前名称 . '直播频道',
                    'vod_play_from' => $播放来源,
                    'vod_play_url' => '直播$' . $行
                ];
                
                记录调试('M3U查找', "成功创建视频信息: {$当前名称}");
                break;
            }
            
            $当前名称 = '';
            $当前图标 = '';
            $当前分组 = '';
        }
    }
    
    fclose($句柄);
    
    if ($视频) {
        记录调试('M3U查找', "成功找到视频");
    } else {
        记录调试('M3U查找', "未找到视频");
    }
    
    return $视频;
}

/**
 * 在数据库文件中按索引查找视频 - 增强磁力链接支持
 */
function 按索引查找数据库视频($文件路径, $表名, $视频索引) {
    记录调试('数据库查找', "在数据库中查找视频，文件: {$文件路径}, 表: {$表名}, 索引: {$视频索引}");
    
    if (!file_exists($文件路径) || !extension_loaded('pdo_sqlite')) {
        记录调试('数据库查找', "文件不存在或SQLite扩展不可用");
        return null;
    }
    
    try {
        $数据库 = new PDO("sqlite:" . $文件路径);
        $数据库->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // 获取表结构
        $字段列表 = $数据库->query("PRAGMA table_info($表名)")->fetchAll(PDO::FETCH_ASSOC);
        $字段名称 = array_column($字段列表, 'name');
        
        记录调试('数据库查找', "表 {$表名} 的字段: " . implode(', ', $字段名称));
        
        // 查找可能的视频字段 - 增强磁力链接支持
        $名称字段 = null;
        $链接字段 = null;
        $磁力字段 = null;
        $电驴字段 = null;
        $图片字段 = null;
        $描述字段 = null;
        $年份字段 = null;
        $地区字段 = null;
        $JSON字段 = null;
        
        foreach ($字段名称 as $字段) {
            $小写字段 = strtolower($字段);
            if (in_array($小写字段, ['name', 'title', 'vod_name', 'filename', 'video_name'])) {
                $名称字段 = $字段;
            } elseif (in_array($小写字段, ['url', 'link', 'vod_url', 'play_url', 'video_url', 'torrent'])) {
                $链接字段 = $字段;
            } elseif (in_array($小写字段, ['magnet', 'magnet_url', 'magnet_link'])) {
                $磁力字段 = $字段;
            } elseif (in_array($小写字段, ['ed2k', 'ed2k_url', 'ed2k_link'])) {
                $电驴字段 = $字段;
            } elseif (in_array($小写字段, ['pic', 'image', 'cover', 'vod_pic', 'poster'])) {
                $图片字段 = $字段;
            } elseif (in_array($小写字段, ['desc', 'description', 'content', 'vod_content'])) {
                $描述字段 = $字段;
            } elseif (in_array($小写字段, ['year', 'vod_year'])) {
                $年份字段 = $字段;
            } elseif (in_array($小写字段, ['area', 'region', 'vod_area'])) {
                $地区字段 = $字段;
            } elseif (in_array($小写字段, ['json', 'data', 'vod_data'])) {
                $JSON字段 = $字段;
            }
        }
        
        if ($名称字段) {
            $选择字段 = [$名称字段];
            if ($链接字段) $选择字段[] = $链接字段;
            if ($磁力字段) $选择字段[] = $磁力字段;
            if ($电驴字段) $选择字段[] = $电驴字段;
            if ($图片字段) $选择字段[] = $图片字段;
            if ($描述字段) $选择字段[] = $描述字段;
            if ($年份字段) $选择字段[] = $年份字段;
            if ($地区字段) $选择字段[] = $地区字段;
            if ($JSON字段) $选择字段[] = $JSON字段;
            
            $查询SQL = "SELECT " . implode(', ', $选择字段) . " FROM $表名 LIMIT 1 OFFSET " . intval($视频索引);
            记录调试('数据库查找', "执行SQL查询: {$查询SQL}");
            
            $语句 = $数据库->query($查询SQL);
            $行数据 = $语句->fetch(PDO::FETCH_ASSOC);
            
            if ($行数据) {
                $默认图片 = [
                    'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg'
                ];
                
                $视频名称 = $行数据[$名称字段] ?? '未知视频';
                
                // 处理JSON数据
                if ($JSON字段 && !empty($行数据[$JSON字段])) {
                    $json数据 = json_decode($行数据[$JSON字段], true);
                    if ($json数据 && isset($json数据['name']) && empty($视频名称)) {
                        $视频名称 = $json数据['name'];
                    }
                }
                
                // 优先使用磁力链接，然后是ed2k，最后是普通URL
                $视频链接 = '';
                $播放来源 = '数据库源';
                
                if ($磁力字段 && !empty($行数据[$磁力字段])) {
                    $视频链接 = $行数据[$磁力字段];
                    $播放来源 = '🧲磁力链接';
                } elseif ($电驴字段 && !empty($行数据[$电驴字段])) {
                    $视频链接 = $行数据[$电驴字段];
                    $播放来源 = '⚡电驴链接';
                } elseif ($链接字段 && !empty($行数据[$链接字段])) {
                    $视频链接 = $行数据[$链接字段];
                    // 检查URL类型
                    if (strpos($视频链接, 'magnet:') === 0) {
                        $播放来源 = '🧲磁力链接';
                    } elseif (strpos($视频链接, 'ed2k://') === 0) {
                        $播放来源 = '⚡电驴链接';
                    }
                }
                
                if (empty($视频链接)) {
                    记录调试('数据库查找', "没有有效的URL链接");
                    $数据库 = null;
                    return null;
                }
                
                $视频封面 = $行数据[$图片字段] ?? $默认图片[intval($视频索引) % count($默认图片)];
                $视频描述 = $行数据[$描述字段] ?? '《' . $视频名称 . '》的精彩内容';
                $视频年份 = $行数据[$年份字段] ?? date('Y');
                $视频地区 = $行数据[$地区字段] ?? '中国大陆';
                
                $视频 = [
                    'vod_id' => 'db_' . md5($文件路径) . '_' . $表名 . '_' . $视频索引,
                    'vod_name' => $视频名称,
                    'vod_pic' => $视频封面,
                    'vod_remarks' => '高清',
                    'vod_year' => $视频年份,
                    'vod_area' => $视频地区,
                    'vod_content' => $视频描述,
                    'vod_play_from' => $播放来源,
                    'vod_play_url' => '正片$' . $视频链接
                ];
                
                记录调试('数据库查找', "成功找到视频: {$视频名称}");
                
                $数据库 = null;
                return $视频;
            } else {
                记录调试('数据库查找', "查询结果为空");
            }
        } else {
            记录调试('数据库查找', "未识别到名称字段");
        }
        
        $数据库 = null;
        return null;
        
    } catch (PDOException $异常) {
        记录调试('数据库查找', "数据库查询失败: " . $异常->getMessage());
        return null;
    }
}

/**
 * 搜索
 */
function 搜索($关键词, $页码) {
    记录调试('搜索', "开始搜索，关键词: {$关键词}, 页码: {$页码}");
    
    if (empty($关键词)) {
        记录调试('搜索', "搜索关键词为空");
        return ['错误' => '请输入搜索关键词'];
    }
    
    $搜索结果 = [];
    $所有文件 = 获取所有文件();
    
    $搜索限制 = 3;
    $已搜索文件 = 0;
    
    记录调试('搜索', "开始搜索文件，限制搜索 {$搜索限制} 个文件");
    
    foreach ($所有文件 as $文件) {
        if ($已搜索文件 >= $搜索限制) {
            记录调试('搜索', "达到搜索文件限制");
            break;
        }
        
        记录调试('搜索', "搜索文件: {$文件['path']}");
        
        $视频列表 = [];
        switch ($文件['type']) {
            case 'json':
                $视频列表 = 解析JSON文件($文件['path']);
                break;
            case 'txt':
                $视频列表 = 解析TXT文件($文件['path']);
                break;
            case 'm3u':
                $视频列表 = 解析M3U文件($文件['path']);
                break;
            case 'db':
                $视频列表 = 解析数据库文件($文件['path']);
                break;
        }
        
        // 跳过错误结果
        if (isset($视频列表['错误'])) {
            记录调试('搜索', "文件解析错误: {$视频列表['错误']}");
            continue;
        }
        
        $文件匹配数 = 0;
        foreach ($视频列表 as $视频) {
            if (stripos($视频['vod_name'] ?? '', $关键词) !== false) {
                $搜索结果[] = 格式化视频项($视频);
                $文件匹配数++;
                
                if (count($搜索结果) >= 30) {
                    记录调试('搜索', "达到搜索结果数量限制");
                    break 2;
                }
            }
        }
        
        记录调试('搜索', "文件 {$文件['path']} 找到 {$文件匹配数} 个匹配结果");
        
        $已搜索文件++;
    }
    
    if (empty($搜索结果)) {
        记录调试('搜索', "未找到相关视频内容");
        return ['错误' => '未找到相关视频内容'];
    }
    
    $每页大小 = 10;
    $总数 = count($搜索结果);
    $总页数 = ceil($总数 / $每页大小);
    $当前页码 = intval($页码);
    
    if ($当前页码 < 1) $当前页码 = 1;
    if ($当前页码 > $总页数) $当前页码 = $总页数;
    
    $起始位置 = ($当前页码 - 1) * $每页大小;
    $分页结果 = array_slice($搜索结果, $起始位置, $每页大小);
    
    记录调试('搜索', "搜索完成: 总共 {$总数} 个结果, 第 {$当前页码}/{$总页数} 页, 显示 " . count($分页结果) . " 个结果");
    
    return [
        'page' => $当前页码,
        'pagecount' => $总页数,
        'limit' => $每页大小,
        'total' => $总数,
        'list' => $分页结果
    ];
}

/**
 * 格式化视频详情
 */
function 格式化视频详情($视频) {
    $格式化 = [
        'vod_id' => $视频['vod_id'] ?? '',
        'vod_name' => $视频['vod_name'] ?? '未知视频',
        'vod_pic' => $视频['vod_pic'] ?? 'https://img3.doubanio.com/view/photo/m_ratio_poster/public/p2921303452.jpg',
        'vod_remarks' => $视频['vod_remarks'] ?? '高清',
        'vod_year' => $视频['vod_year'] ?? '',
        'vod_area' => $视频['vod_area'] ?? '中国大陆',
        'vod_director' => $视频['vod_director'] ?? '',
        'vod_actor' => $视频['vod_actor'] ?? '',
        'vod_content' => $视频['vod_content'] ?? '视频详情内容',
        'vod_play_from' => $视频['vod_play_from'] ?? 'default',
        'vod_play_url' => $视频['vod_play_url'] ?? ''
    ];
    
    记录调试('详情格式化', "格式化视频详情: {$格式化['vod_name']}");
    
    return $格式化;
}

/**
 * 获取播放地址 - 增强磁力链接支持
 */
function 获取播放($标志, $标识) {
    记录调试('播放', "获取播放地址，标志: {$标志}, 标识: {$标识}");
    
    // 记录播放请求详情
    记录调试('链接处理', "播放请求 - 标志: {$标志}, 链接: " . substr($标识, 0, 100));
    
    // 直接返回播放地址，TVBox播放器会处理磁力链接和ed2k链接
    $结果 = [
        'parse' => 0,
        'playUrl' => '',
        'url' => $标识,
        'type' => 'video'
    ];
    
    记录调试('播放', "返回播放信息: " . json_encode($结果));
    
    return $结果;
}
?>