<?php
/**
 * TVBox PHP çˆ¬è™«è„šæœ¬ - ç£åŠ›å¢å¼ºç‰ˆ + å…¨æ•°æ®åº“å…¼å®¹
 * æ”¯æŒJSON/TXT/M3U/DBæ–‡ä»¶æ ¼å¼ + ç£åŠ›é“¾æ¥ + ed2ké“¾æ¥
 * å®Œæ•´ç£åŠ›æ–‡ä»¶å¤¹æ‰«æå’Œæ™ºèƒ½å‘½ååŠŸèƒ½
 * å¢å¼ºæ•°æ®åº“å…¼å®¹ï¼šæ”¯æŒå¸‚é¢ä¸Šå¤§å¤šæ•°æ•°æ®åº“æ ¼å¼
 */
ini_set('memory_limit', '-1');

// ==================== æ•°æ®åº“å…¼å®¹é…ç½® ====================
define('DB_COMPAT_MODE', true);
define('MAX_DB_RESULTS', 5000); // æœ€å¤§æ•°æ®åº“ç»“æœæ•°
define('DB_SCAN_DEPTH', 10);    // æ•°æ®åº“æ‰«ææ·±åº¦

// æ”¯æŒçš„æ•°æ®åº“è¡¨åæ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
$SUPPORTED_DB_TABLES = [
    'video' => '/^(videos?|film|movie|tv|series|å½±è§†|è§†é¢‘)/i',
    'category' => '/^(categor(y|ies)|type|åˆ†ç±»|ç±»å‹)/i',
    'magnet' => '/^(magnet|bt|torrent|ç§å­|ç£åŠ›)/i',
    'channel' => '/^(channel|tv_channel|live|é¢‘é“|ç›´æ’­)/i'
];

// æ•°æ®åº“å­—æ®µæ˜ å°„é…ç½®
$DB_FIELD_MAPPING = [
    'id' => ['id', 'vid', 'video_id', 'film_id'],
    'name' => ['name', 'title', 'video_name', 'film_name', 'vod_name'],
    'url' => ['url', 'link', 'play_url', 'video_url', 'vod_url'],
    'magnet' => ['magnet', 'magnet_url', 'magnet_link', 'bt_url'],
    'image' => ['image', 'pic', 'cover', 'poster', 'vod_pic'],
    'category' => ['category', 'type', 'class', 'vod_type'],
    'year' => ['year', 'vod_year'],
    'area' => ['area', 'region', 'vod_area'],
    'actor' => ['actor', 'star', 'vod_actor'],
    'director' => ['director', 'vod_director'],
    'content' => ['content', 'desc', 'description', 'vod_content']
];
// ==================== æ•°æ®åº“å…¼å®¹é…ç½®ç»“æŸ ====================

// è·å–è¯·æ±‚å‚æ•°
$æ“ä½œç±»å‹ = $_GET['ac'] ?? 'detail';
$åˆ†ç±»æ ‡è¯† = $_GET['t'] ?? '';
$é¡µç  = $_GET['pg'] ?? '1';
$è§†é¢‘æ ‡è¯† = $_GET['ids'] ?? '';
$æœç´¢å…³é”®è¯ = $_GET['wd'] ?? '';
$æ’­æ”¾æ ‡å¿— = $_GET['flag'] ?? '';
$æ’­æ”¾æ ‡è¯† = $_GET['id'] ?? '';

// è®¾ç½®å“åº”å¤´ä¸º JSON
header('Content-Type: application/json; charset=utf-8');

// æ€§èƒ½ä¼˜åŒ– - å¢åŠ è¶…æ—¶æ—¶é—´
@set_time_limit(120);

// æ ¹æ®ä¸åŒ action è¿”å›æ•°æ®
switch ($æ“ä½œç±»å‹) {
    case 'detail':
        if (!empty($è§†é¢‘æ ‡è¯†)) {
            $ç»“æœ = è·å–è¯¦æƒ…($è§†é¢‘æ ‡è¯†);
        } elseif (!empty($åˆ†ç±»æ ‡è¯†)) {
            $ç»“æœ = è·å–åˆ†ç±»($åˆ†ç±»æ ‡è¯†, $é¡µç );
        } else {
            $ç»“æœ = è·å–é¦–é¡µ();
        }
        break;
    
    case 'search':
        $ç»“æœ = æœç´¢($æœç´¢å…³é”®è¯, $é¡µç );
        break;
        
    case 'play':
        $ç»“æœ = è·å–æ’­æ”¾($æ’­æ”¾æ ‡å¿—, $æ’­æ”¾æ ‡è¯†);
        break;
    
    default:
        $ç»“æœ = ['é”™è¯¯' => 'æœªçŸ¥æ“ä½œ: ' . $æ“ä½œç±»å‹];
}

echo json_encode($ç»“æœ, JSON_UNESCAPED_UNICODE);
/**
 * é€’å½’æ‰«æç›®å½• - æ”¯æŒæ— é™çº§å­æ–‡ä»¶å¤¹
 */
function é€’å½’æ‰«æç›®å½•($ç›®å½•, $æ–‡ä»¶ç±»å‹, $å½“å‰æ·±åº¦ = 0, $æœ€å¤§æ·±åº¦ = 20) {
    $æ–‡ä»¶åˆ—è¡¨ = [];
    
    if (!is_dir($ç›®å½•)) {
        return $æ–‡ä»¶åˆ—è¡¨;
    }
    
    if ($å½“å‰æ·±åº¦ > $æœ€å¤§æ·±åº¦) {
        return $æ–‡ä»¶åˆ—è¡¨;
    }
    
    $ç›®å½•é¡¹ = @scandir($ç›®å½•);
    if ($ç›®å½•é¡¹ === false) {
        return $æ–‡ä»¶åˆ—è¡¨;
    }
    
    foreach ($ç›®å½•é¡¹ as $é¡¹ç›®) {
        if ($é¡¹ç›® === '.' || $é¡¹ç›® === '..') continue;
        
        $è·¯å¾„ = $ç›®å½• . $é¡¹ç›®;
        
        if (is_dir($è·¯å¾„)) {
            $å­æ–‡ä»¶ = é€’å½’æ‰«æç›®å½•($è·¯å¾„ . '/', $æ–‡ä»¶ç±»å‹, $å½“å‰æ·±åº¦ + 1, $æœ€å¤§æ·±åº¦);
            $æ–‡ä»¶åˆ—è¡¨ = array_merge($æ–‡ä»¶åˆ—è¡¨, $å­æ–‡ä»¶);
        } else {
            $æ‰©å±•å = strtolower(pathinfo($è·¯å¾„, PATHINFO_EXTENSION));
            if (in_array($æ‰©å±•å, $æ–‡ä»¶ç±»å‹)) {
                $ç›¸å¯¹è·¯å¾„ = str_replace('/storage/emulated/0/æ±Ÿæ¹–/', '', $è·¯å¾„);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç£åŠ›æ–‡ä»¶å¤¹
                $æ˜¯ç£åŠ›æ–‡ä»¶å¤¹ = (strpos($è·¯å¾„, '/æ±Ÿæ¹–/wj/bt/') !== false);
                
                $æ–‡ä»¶åˆ—è¡¨[] = [
                    'type' => $æ‰©å±•å,
                    'path' => $è·¯å¾„,
                    'name' => $é¡¹ç›®,
                    'filename' => pathinfo($é¡¹ç›®, PATHINFO_FILENAME),
                    'relative_path' => $ç›¸å¯¹è·¯å¾„,
                    'depth' => $å½“å‰æ·±åº¦,
                    'is_magnet_folder' => $æ˜¯ç£åŠ›æ–‡ä»¶å¤¹
                ];
            }
        }
    }
    
    return $æ–‡ä»¶åˆ—è¡¨;
}

/**
 * è·å–æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ - å¢å¼ºç£åŠ›æ–‡ä»¶å¤¹å’Œæ•°æ®åº“æ”¯æŒ
 */
function è·å–æ‰€æœ‰æ–‡ä»¶() {
    static $æ‰€æœ‰æ–‡ä»¶ = null;
    
    if ($æ‰€æœ‰æ–‡ä»¶ === null) {
        $æ‰€æœ‰æ–‡ä»¶ = [];
        
        $JSONæ–‡ä»¶ = é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/json/å½±è§†/', ['json']);
        $TXTæ–‡ä»¶ = é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/wj/', ['txt']);
        $M3Uæ–‡ä»¶ = array_merge(
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/json/å½±è§†/', ['m3u']),
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/wj/', ['m3u'])
        );
        
        // å¢å¼ºæ•°æ®åº“æ–‡ä»¶æ‰«æï¼ŒåŒ…å«æ‰€æœ‰å¯èƒ½çš„æ•°æ®åº“è·¯å¾„
        $æ•°æ®åº“æ–‡ä»¶ = array_merge(
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/json/å½±è§†/', ['db', 'sqlite', 'sqlite3', 'db3']),
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/wj/', ['db', 'sqlite', 'sqlite3', 'db3']),
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/db/', ['db', 'sqlite', 'sqlite3', 'db3']),
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/wj/bt/', ['db', 'sqlite', 'sqlite3', 'db3']),
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/data/', ['db', 'sqlite', 'sqlite3', 'db3']),
            é€’å½’æ‰«æç›®å½•('/storage/emulated/0/æ±Ÿæ¹–/æ•°æ®åº“/', ['db', 'sqlite', 'sqlite3', 'db3'])
        );
        
        $æ‰€æœ‰æ–‡ä»¶ = array_merge($JSONæ–‡ä»¶, $TXTæ–‡ä»¶, $M3Uæ–‡ä»¶, $æ•°æ®åº“æ–‡ä»¶);
        
        // æŒ‰è·¯å¾„æ’åº
        usort($æ‰€æœ‰æ–‡ä»¶, function($ç”², $ä¹™) {
            return strcmp($ç”²['relative_path'], $ä¹™['relative_path']);
        });
    }
    
    return $æ‰€æœ‰æ–‡ä»¶;
}

/**
 * ä¼°ç®—æ–‡ä»¶ä¸­çš„è§†é¢‘æ•°é‡ï¼ˆå¿«é€Ÿä¼°ç®—ï¼Œä¸å®é™…è§£æï¼‰
 */
function ä¼°ç®—æ–‡ä»¶è§†é¢‘æ•°é‡($æ–‡ä»¶) {
    $è·¯å¾„ = $æ–‡ä»¶['path'];
    $ç±»å‹ = $æ–‡ä»¶['type'];
    
    if (!file_exists($è·¯å¾„)) {
        return 0;
    }
    
    $æ–‡ä»¶å¤§å° = filesize($è·¯å¾„);
    
    // æ ¹æ®æ–‡ä»¶ç±»å‹å’Œå¤§å°å¿«é€Ÿä¼°ç®—
    switch ($ç±»å‹) {
        case 'json':
            $æ•°é‡ = $æ–‡ä»¶å¤§å° > 1024 ? intval($æ–‡ä»¶å¤§å° / 1024) : 1;
            break;
        case 'txt':
            $è¡Œæ•° = $æ–‡ä»¶å¤§å° > 100 ? intval($æ–‡ä»¶å¤§å° / 100) : 1;
            $æ•°é‡ = min($è¡Œæ•°, 10000);
            break;
        case 'm3u':
            $è¡Œæ•° = $æ–‡ä»¶å¤§å° > 200 ? intval($æ–‡ä»¶å¤§å° / 200) : 1;
            $æ•°é‡ = min($è¡Œæ•°, 5000);
            break;
        case 'db':
        case 'sqlite':
        case 'sqlite3':
        case 'db3':
            $æ•°é‡ = $æ–‡ä»¶å¤§å° > 500 ? intval($æ–‡ä»¶å¤§å° / 500) : 1;
            break;
        default:
            $æ•°é‡ = 0;
    }
    
    return $æ•°é‡;
}
/**
 * è·å–åˆ†ç±»åˆ—è¡¨
 */
function è·å–åˆ†ç±»åˆ—è¡¨() {
    static $åˆ†ç±»åˆ—è¡¨ = null;
    
    if ($åˆ†ç±»åˆ—è¡¨ === null) {
        $æ‰€æœ‰æ–‡ä»¶ = è·å–æ‰€æœ‰æ–‡ä»¶();
        $åˆ†ç±»åˆ—è¡¨ = [];
        
        // æ–°å¢çƒ­é—¨æ¨èåˆ†ç±»
        $æ€»æ–‡ä»¶æ•° = count($æ‰€æœ‰æ–‡ä»¶);
        $åˆ†ç±»åˆ—è¡¨[] = [
            'type_id' => 'hot',
            'type_name' => 'ğŸ”¥çƒ­é—¨æ¨è (' . $æ€»æ–‡ä»¶æ•° . 'ä¸ªæ–‡ä»¶)',
            'type_file' => 'hot_recommend',
            'source_path' => 'hot',
            'source_type' => 'hot'
        ];
        
        // ç”¨äºå»é‡çš„æ•°ç»„
        $å·²å¤„ç†æ–‡ä»¶ = [];
        
        // æ–‡ä»¶åˆ†ç±»ï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼‰
        foreach ($æ‰€æœ‰æ–‡ä»¶ as $ç´¢å¼• => $æ–‡ä»¶) {
            // å»é‡ï¼šåŸºäºæ–‡ä»¶è·¯å¾„å’Œåç§°
            $æ–‡ä»¶æ ‡è¯† = $æ–‡ä»¶['path'] . '|' . $æ–‡ä»¶['name'];
            if (in_array($æ–‡ä»¶æ ‡è¯†, $å·²å¤„ç†æ–‡ä»¶)) {
                continue;
            }
            $å·²å¤„ç†æ–‡ä»¶[] = $æ–‡ä»¶æ ‡è¯†;
            
            $æ–‡ä»¶ç±»å‹ = '';
            $ç±»å‹å›¾æ ‡ = '';
            $æ•°é‡æ˜¾ç¤º = '';
            
            switch ($æ–‡ä»¶['type']) {
                case 'json':
                    $æ–‡ä»¶ç±»å‹ = '[JSON] ';
                    $ç±»å‹å›¾æ ‡ = 'ğŸ“Š ';
                    break;
                case 'txt':
                    $æ–‡ä»¶ç±»å‹ = '[TXT] ';
                    $ç±»å‹å›¾æ ‡ = 'ğŸ“„ ';
                    break;
                case 'm3u':
                    $æ–‡ä»¶ç±»å‹ = '[M3U] ';
                    $ç±»å‹å›¾æ ‡ = 'ğŸ“º ';
                    break;
                case 'db':
                case 'sqlite':
                case 'sqlite3':
                case 'db3':
                    $æ–‡ä»¶ç±»å‹ = '[æ•°æ®åº“] ';
                    $ç±»å‹å›¾æ ‡ = 'ğŸ—ƒï¸ ';
                    
                    // å°è¯•è·å–æ•°æ®åº“ä¸­çš„è¡¨æ•°é‡
                    try {
                        if (file_exists($æ–‡ä»¶['path']) && extension_loaded('pdo_sqlite')) {
                            $æ•°æ®åº“ = new PDO("sqlite:" . $æ–‡ä»¶['path']);
                            $è¡¨åˆ—è¡¨ = $æ•°æ®åº“->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
                            $è¡¨æ•°é‡ = count($è¡¨åˆ—è¡¨);
                            $æ•°æ®åº“ = null;
                            
                            $æ•°é‡æ˜¾ç¤º = ' (' . $è¡¨æ•°é‡ . 'ä¸ªè¡¨)';
                        } else {
                            $æ•°é‡æ˜¾ç¤º = ' (æ•°æ®åº“)';
                        }
                    } catch (Exception $e) {
                        $æ•°é‡æ˜¾ç¤º = ' (æ•°æ®åº“)';
                    }
                    break;
            }
            
            // å¦‚æœæ²¡æœ‰æ•°é‡æ˜¾ç¤ºï¼Œä½¿ç”¨ä¼°ç®—çš„è§†é¢‘æ•°é‡
            if (empty($æ•°é‡æ˜¾ç¤º)) {
                $è§†é¢‘æ•°é‡ = ä¼°ç®—æ–‡ä»¶è§†é¢‘æ•°é‡($æ–‡ä»¶);
                $æ•°é‡æ˜¾ç¤º = $è§†é¢‘æ•°é‡ > 0 ? ' (' . number_format($è§†é¢‘æ•°é‡) . 'ä¸ªè§†é¢‘)' : '';
            }
            
            // ç£åŠ›æ–‡ä»¶å¤¹æ ‡è¯†
            if ($æ–‡ä»¶['is_magnet_folder']) {
                $ç±»å‹å›¾æ ‡ = 'ğŸ§² ';
                $æ–‡ä»¶ç±»å‹ = '[ç£åŠ›] ';
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶å¤¹è·¯å¾„
            $æ–‡ä»¶å¤¹ä¿¡æ¯ = '';
            if (strpos($æ–‡ä»¶['relative_path'], '/') !== false) {
                $æ–‡ä»¶å¤¹è·¯å¾„ = dirname($æ–‡ä»¶['relative_path']);
                $æ–‡ä»¶å¤¹ä¿¡æ¯ = ' ğŸ“ ' . $æ–‡ä»¶å¤¹è·¯å¾„;
            }
            
            $åˆ†ç±»åˆ—è¡¨[] = [
                'type_id' => (string)($ç´¢å¼• + 1),
                'type_name' => $ç±»å‹å›¾æ ‡ . $æ–‡ä»¶ç±»å‹ . $æ–‡ä»¶['filename'] . $æ•°é‡æ˜¾ç¤º . $æ–‡ä»¶å¤¹ä¿¡æ¯,
                'type_file' => $æ–‡ä»¶['name'],
                'source_path' => $æ–‡ä»¶['path'],
                'source_type' => $æ–‡ä»¶['type'],
                'video_count' => ä¼°ç®—æ–‡ä»¶è§†é¢‘æ•°é‡($æ–‡ä»¶),
                'is_magnet_folder' => $æ–‡ä»¶['is_magnet_folder']
            ];
        }
        
        if (empty($æ‰€æœ‰æ–‡ä»¶)) {
            $åˆ†ç±»åˆ—è¡¨[] = [
                'type_id' => '1',
                'type_name' => 'â“ æœªæ‰¾åˆ°åª’ä½“æ–‡ä»¶',
                'type_file' => 'empty',
                'source_path' => 'empty',
                'source_type' => 'empty'
            ];
        }
    }
    
    return $åˆ†ç±»åˆ—è¡¨;
}

/**
 * è·å–çƒ­é—¨æ¨èè§†é¢‘ - ä»æ‰€æœ‰åˆ†ç±»ä¸­éšæœºè·å–
 */
function è·å–çƒ­é—¨è§†é¢‘($é¡µç , $æ¯é¡µæ•°é‡ = 15) {
    static $æ‰€æœ‰çƒ­é—¨è§†é¢‘ = null;
    static $å·²ä½¿ç”¨è§†é¢‘æ ‡è¯† = [];
    
    if ($é¡µç  == 1) {
        $å·²ä½¿ç”¨è§†é¢‘æ ‡è¯† = [];
    }
    
    if ($æ‰€æœ‰çƒ­é—¨è§†é¢‘ === null) {
        $æ‰€æœ‰çƒ­é—¨è§†é¢‘ = [];
        $æ‰€æœ‰æ–‡ä»¶ = è·å–æ‰€æœ‰æ–‡ä»¶();
        
        foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
            if (!file_exists($æ–‡ä»¶['path'])) {
                continue;
            }
            
            $è§†é¢‘åˆ—è¡¨ = [];
            switch ($æ–‡ä»¶['type']) {
                case 'json':
                    $è§†é¢‘åˆ—è¡¨ = è§£æJSONæ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                case 'txt':
                    $è§†é¢‘åˆ—è¡¨ = è§£æTXTæ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                case 'm3u':
                    $è§†é¢‘åˆ—è¡¨ = è§£æM3Uæ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                case 'db':
                case 'sqlite':
                case 'sqlite3':
                case 'db3':
                    $è§†é¢‘åˆ—è¡¨ = è§£ææ•°æ®åº“æ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
            }
            
            if (isset($è§†é¢‘åˆ—è¡¨['é”™è¯¯'])) {
                continue;
            }
            
            if (count($è§†é¢‘åˆ—è¡¨) > 100) {
                $è§†é¢‘åˆ—è¡¨ = array_slice($è§†é¢‘åˆ—è¡¨, 0, 100);
            }
            
            $æ‰€æœ‰çƒ­é—¨è§†é¢‘ = array_merge($æ‰€æœ‰çƒ­é—¨è§†é¢‘, $è§†é¢‘åˆ—è¡¨);
            
            if (count($æ‰€æœ‰çƒ­é—¨è§†é¢‘) > 1000) {
                break;
            }
        }
    }
    
    if (empty($æ‰€æœ‰çƒ­é—¨è§†é¢‘)) {
        return [];
    }
    
    $å¯ç”¨è§†é¢‘ = [];
    foreach ($æ‰€æœ‰çƒ­é—¨è§†é¢‘ as $è§†é¢‘) {
        $è§†é¢‘æ ‡è¯† = $è§†é¢‘['vod_id'] ?? '';
        if (!in_array($è§†é¢‘æ ‡è¯†, $å·²ä½¿ç”¨è§†é¢‘æ ‡è¯†)) {
            $å¯ç”¨è§†é¢‘[] = $è§†é¢‘;
        }
    }
    
    if (empty($å¯ç”¨è§†é¢‘)) {
        $å·²ä½¿ç”¨è§†é¢‘æ ‡è¯† = [];
        $å¯ç”¨è§†é¢‘ = $æ‰€æœ‰çƒ­é—¨è§†é¢‘;
    }
    
    $é€‰ä¸­è§†é¢‘ = [];
    $éœ€è¦æ•°é‡ = min($æ¯é¡µæ•°é‡, count($å¯ç”¨è§†é¢‘));
    
    if ($éœ€è¦æ•°é‡ > 0) {
        $éšæœºé”® = array_rand($å¯ç”¨è§†é¢‘, $éœ€è¦æ•°é‡);
        if (!is_array($éšæœºé”®)) {
            $éšæœºé”® = [$éšæœºé”®];
        }
        
        foreach ($éšæœºé”® as $é”®) {
            $é€‰ä¸­è§†é¢‘é¡¹ = $å¯ç”¨è§†é¢‘[$é”®];
            $é€‰ä¸­è§†é¢‘[] = $é€‰ä¸­è§†é¢‘é¡¹;
            $å·²ä½¿ç”¨è§†é¢‘æ ‡è¯†[] = $é€‰ä¸­è§†é¢‘é¡¹['vod_id'] ?? '';
        }
    }
    
    return $é€‰ä¸­è§†é¢‘;
}

/**
 * é¦–é¡µæ•°æ®
 */
function è·å–é¦–é¡µ() {
    $åˆ†ç±»åˆ—è¡¨ = è·å–åˆ†ç±»åˆ—è¡¨();
    
    if (empty($åˆ†ç±»åˆ—è¡¨)) {
        return ['é”™è¯¯' => 'æœªæ‰¾åˆ°ä»»ä½•æ–‡ä»¶'];
    }
    
    return [
        'class' => $åˆ†ç±»åˆ—è¡¨
    ];
}
/**
 * å¢å¼ºç‰ˆæ•°æ®åº“è§£æ - æ”¯æŒå¸‚é¢ä¸Šå¤§å¤šæ•°æ•°æ®åº“æ ¼å¼
 */
function è§£ææ•°æ®åº“æ–‡ä»¶($æ–‡ä»¶è·¯å¾„) {
    global $SUPPORTED_DB_TABLES, $DB_FIELD_MAPPING;
    
    if (!file_exists($æ–‡ä»¶è·¯å¾„)) {
        return ['é”™è¯¯' => 'æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    $æ–‡ä»¶å¤§å° = filesize($æ–‡ä»¶è·¯å¾„);
    $å¯è¯» = is_readable($æ–‡ä»¶è·¯å¾„);
    
    if ($æ–‡ä»¶å¤§å° === 0) {
        return ['é”™è¯¯' => 'æ•°æ®åº“æ–‡ä»¶ä¸ºç©º: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    if (!$å¯è¯») {
        return ['é”™è¯¯' => 'æ•°æ®åº“æ–‡ä»¶ä¸å¯è¯»: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    if (!extension_loaded('pdo_sqlite')) {
        return ['é”™è¯¯' => 'PDO_SQLiteæ‰©å±•ä¸å¯ç”¨ï¼Œæ— æ³•è¯»å–æ•°æ®åº“æ–‡ä»¶'];
    }
    
    try {
        $æ•°æ®åº“ = new PDO("sqlite:" . $æ–‡ä»¶è·¯å¾„);
        $æ•°æ®åº“->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // è·å–æ‰€æœ‰è¡¨
        $è¡¨åˆ—è¡¨ = $æ•°æ®åº“->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
        
        if (empty($è¡¨åˆ—è¡¨)) {
            return ['é”™è¯¯' => 'æ•°æ®åº“ä¸­æœªæ‰¾åˆ°ä»»ä½•æ•°æ®è¡¨'];
        }
        
        // æ™ºèƒ½è¯†åˆ«æ•°æ®åº“ç±»å‹å¹¶è§£æ
        $æ•°æ®åº“ç±»å‹ = è¯†åˆ«æ•°æ®åº“ç±»å‹($è¡¨åˆ—è¡¨, $æ•°æ®åº“);
        
        switch ($æ•°æ®åº“ç±»å‹) {
            case 'video_category':
                return è§£æè§†é¢‘åˆ†ç±»æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„);
            case 'magnet_database':
                return è§£æç£åŠ›æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„);
            case 'live_channel':
                return è§£æç›´æ’­é¢‘é“æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„);
            case 'universal_video':
                return è§£æé€šç”¨è§†é¢‘æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„);
            default:
                return è§£æè‡ªåŠ¨è¯†åˆ«æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„, $è¡¨åˆ—è¡¨);
        }
        
    } catch (PDOException $å¼‚å¸¸) {
        return ['é”™è¯¯' => 'æ•°æ®åº“è¯»å–å¤±è´¥: ' . $å¼‚å¸¸->getMessage()];
    }
}

/**
 * æ™ºèƒ½è¯†åˆ«æ•°æ®åº“ç±»å‹
 */
function è¯†åˆ«æ•°æ®åº“ç±»å‹($è¡¨åˆ—è¡¨, $æ•°æ®åº“) {
    global $SUPPORTED_DB_TABLES;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘åˆ†ç±»æ•°æ®åº“
    if (in_array('videos', $è¡¨åˆ—è¡¨) && in_array('categories', $è¡¨åˆ—è¡¨)) {
        return 'video_category';
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç£åŠ›æ•°æ®åº“
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (preg_match($SUPPORTED_DB_TABLES['magnet'], $è¡¨å)) {
            return 'magnet_database';
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ’­é¢‘é“æ•°æ®åº“
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (preg_match($SUPPORTED_DB_TABLES['channel'], $è¡¨å)) {
            return 'live_channel';
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é€šç”¨è§†é¢‘æ•°æ®åº“
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (preg_match($SUPPORTED_DB_TABLES['video'], $è¡¨å)) {
            return 'universal_video';
        }
    }
    
    return 'auto_detect';
}

/**
 * è§£æè§†é¢‘åˆ†ç±»æ•°æ®åº“ - ä¸“é—¨å¤„ç†åˆ†ç±»è§†é¢‘æ•°æ®
 */
function è§£æè§†é¢‘åˆ†ç±»æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„) {
    $è§†é¢‘åˆ—è¡¨ = [];
    
    // è·å–åˆ†ç±»ä¿¡æ¯
    $åˆ†ç±»æ˜ å°„ = [];
    $åˆ†ç±»ç»“æœ = $æ•°æ®åº“->query("SELECT id, name FROM categories")->fetchAll(PDO::FETCH_ASSOC);
    foreach ($åˆ†ç±»ç»“æœ as $åˆ†ç±») {
        $åˆ†ç±»æ˜ å°„[$åˆ†ç±»['id']] = $åˆ†ç±»['name'];
    }
    
    // è·å–è§†é¢‘æ•°æ®
    $è§†é¢‘ç»“æœ = $æ•°æ®åº“->query("SELECT id, category_id, name, image, actor, director, remarks, pubdate, area, year, content, play_url FROM videos LIMIT " . MAX_DB_RESULTS)->fetchAll(PDO::FETCH_ASSOC);
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662',
        'https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2640235365.jpg',
        'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2640235366.jpg'
    ];
    
    foreach ($è§†é¢‘ç»“æœ as $ç´¢å¼• => $è§†é¢‘æ•°æ®) {
        $è§†é¢‘åç§° = $è§†é¢‘æ•°æ®['name'] ?? 'æœªçŸ¥è§†é¢‘';
        $æ’­æ”¾é“¾æ¥ = $è§†é¢‘æ•°æ®['play_url'] ?? '';
        
        if (empty($æ’­æ”¾é“¾æ¥)) {
            continue;
        }
        
        // å¤„ç†æ’­æ”¾é“¾æ¥æ ¼å¼
        $æ’­æ”¾æ¥æº = 'è§†é¢‘æº';
        $æ’­æ”¾åœ°å€ = $æ’­æ”¾é“¾æ¥;
        
        // æ£€æŸ¥é“¾æ¥ç±»å‹
        if (strpos($æ’­æ”¾é“¾æ¥, 'magnet:') === 0) {
            $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
        } elseif (strpos($æ’­æ”¾é“¾æ¥, 'ed2k://') === 0) {
            $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
        } elseif (strpos($æ’­æ”¾é“¾æ¥, 'http') === 0) {
            $æ’­æ”¾æ¥æº = 'åœ¨çº¿æ’­æ”¾';
        }
        
        // è·å–åˆ†ç±»åç§°
        $åˆ†ç±»åç§° = $åˆ†ç±»æ˜ å°„[$è§†é¢‘æ•°æ®['category_id']] ?? 'æœªçŸ¥åˆ†ç±»';
        
        $è§†é¢‘åˆ—è¡¨[] = [
            'vod_id' => 'video_' . $è§†é¢‘æ•°æ®['id'],
            'vod_name' => $è§†é¢‘åç§°,
            'vod_pic' => $è§†é¢‘æ•°æ®['image'] ?? $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)],
            'vod_remarks' => $è§†é¢‘æ•°æ®['remarks'] ?? 'é«˜æ¸…',
            'vod_year' => $è§†é¢‘æ•°æ®['year'] ?? '',
            'vod_area' => $è§†é¢‘æ•°æ®['area'] ?? 'ä¸­å›½å¤§é™†',
            'vod_actor' => $è§†é¢‘æ•°æ®['actor'] ?? '',
            'vod_director' => $è§†é¢‘æ•°æ®['director'] ?? '',
            'vod_content' => $è§†é¢‘æ•°æ®['content'] ?? $è§†é¢‘åç§° . 'çš„ç²¾å½©å†…å®¹',
            'vod_play_from' => $æ’­æ”¾æ¥æº . ' Â· ' . $åˆ†ç±»åç§°,
            'vod_play_url' => 'æ­£ç‰‡$' . $æ’­æ”¾åœ°å€
        ];
        
        if (count($è§†é¢‘åˆ—è¡¨) >= MAX_DB_RESULTS) {
            break;
        }
    }
    
    return $è§†é¢‘åˆ—è¡¨;
}

/**
 * è§£æç£åŠ›æ•°æ®åº“ - åŸæ¥çš„ç£åŠ›æ•°æ®åº“è§£æé€»è¾‘
 */
function è§£æç£åŠ›æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„) {
    $è§†é¢‘åˆ—è¡¨ = [];
    
    $è¡¨åˆ—è¡¨ = $æ•°æ®åº“->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
    
    if (empty($è¡¨åˆ—è¡¨)) {
        return ['é”™è¯¯' => 'æ•°æ®åº“ä¸­æœªæ‰¾åˆ°ä»»ä½•æ•°æ®è¡¨'];
    }
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662',
        'https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2640235365.jpg',
        'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2640235366.jpg'
    ];
    
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (strpos($è¡¨å, 'sqlite_') === 0) continue;
        
        $å­—æ®µåˆ—è¡¨ = $æ•°æ®åº“->query("PRAGMA table_info($è¡¨å)")->fetchAll(PDO::FETCH_ASSOC);
        $å­—æ®µåç§° = array_column($å­—æ®µåˆ—è¡¨, 'name');
        
        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœè¡¨æœ‰dataå­—æ®µï¼Œå‡è®¾å®ƒåŒ…å«JSONæ•°æ®
        if (in_array('data', $å­—æ®µåç§°)) {
            $ç»“æœé›† = $æ•°æ®åº“->query("SELECT data FROM $è¡¨å LIMIT " . MAX_DB_RESULTS)->fetchAll(PDO::FETCH_COLUMN);
            
            foreach ($ç»“æœé›† as $ç´¢å¼• => $jsonæ•°æ®) {
                if (empty($jsonæ•°æ®)) continue;
                
                $è§†é¢‘æ•°æ® = json_decode($jsonæ•°æ®, true);
                if ($è§†é¢‘æ•°æ® && is_array($è§†é¢‘æ•°æ®)) {
                    // æ­£ç¡®æå–è§†é¢‘ä¿¡æ¯
                    $è§†é¢‘åç§° = $è§†é¢‘æ•°æ®['title'] ?? $è§†é¢‘æ•°æ®['name'] ?? 'æœªçŸ¥è§†é¢‘';
                    $è§†é¢‘é“¾æ¥ = '';
                    $æ’­æ”¾æ¥æº = 'æ•°æ®åº“æº';
                    
                    // ä¼˜å…ˆä½¿ç”¨ç£åŠ›é“¾æ¥
                    if (isset($è§†é¢‘æ•°æ®['magnet']) && !empty($è§†é¢‘æ•°æ®['magnet'])) {
                        $è§†é¢‘é“¾æ¥ = $è§†é¢‘æ•°æ®['magnet'];
                        $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                    } elseif (isset($è§†é¢‘æ•°æ®['torrent']) && !empty($è§†é¢‘æ•°æ®['torrent'])) {
                        $è§†é¢‘é“¾æ¥ = $è§†é¢‘æ•°æ®['torrent'];
                        $æ’­æ”¾æ¥æº = 'ğŸ”—ç§å­é“¾æ¥';
                    }
                    
                    if (empty($è§†é¢‘é“¾æ¥)) {
                        continue;
                    }
                    
                    // ç”Ÿæˆè§†é¢‘å°é¢
                    $è§†é¢‘å°é¢ = $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)];
                    
                    // æå–å…¶ä»–ä¿¡æ¯
                    $è§†é¢‘æè¿° = $è§†é¢‘æ•°æ®['title'] ?? 'ã€Š' . $è§†é¢‘åç§° . 'ã€‹çš„ç²¾å½©å†…å®¹';
                    $è§†é¢‘å¹´ä»½ = $è§†é¢‘æ•°æ®['year'] ?? date('Y');
                    $è§†é¢‘åœ°åŒº = 'æ¬§ç¾'; // æ ¹æ®å®é™…æ•°æ®è°ƒæ•´
                    
                    // ç”Ÿæˆå”¯ä¸€ID
                    $è§†é¢‘ID = 'db_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $ç´¢å¼•;
                    
                    $è§†é¢‘åˆ—è¡¨[] = [
                        'vod_id' => $è§†é¢‘ID,
                        'vod_name' => $è§†é¢‘åç§°,
                        'vod_pic' => $è§†é¢‘å°é¢,
                        'vod_remarks' => 'é«˜æ¸…',
                        'vod_year' => $è§†é¢‘å¹´ä»½,
                        'vod_area' => $è§†é¢‘åœ°åŒº,
                        'vod_content' => $è§†é¢‘æè¿°,
                        'vod_play_from' => $æ’­æ”¾æ¥æº,
                        'vod_play_url' => 'æ­£ç‰‡$' . $è§†é¢‘é“¾æ¥
                    ];
                    
                    if (count($è§†é¢‘åˆ—è¡¨) >= MAX_DB_RESULTS) {
                        break 2;
                    }
                }
            }
        } else {  
            $åç§°å­—æ®µ = null;
            $é“¾æ¥å­—æ®µ = null;
            $ç£åŠ›å­—æ®µ = null;
            $ç”µé©´å­—æ®µ = null;
            $å›¾ç‰‡å­—æ®µ = null;
            $æè¿°å­—æ®µ = null;
            $å¹´ä»½å­—æ®µ = null;
            $åœ°åŒºå­—æ®µ = null;
            $JSONå­—æ®µ = null;
            
            foreach ($å­—æ®µåç§° as $å­—æ®µ) {
                $å°å†™å­—æ®µ = strtolower($å­—æ®µ);
                if (in_array($å°å†™å­—æ®µ, ['name', 'title', 'vod_name', 'filename', 'video_name'])) {
                    $åç§°å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['url', 'link', 'vod_url', 'play_url', 'video_url', 'torrent'])) {
                    $é“¾æ¥å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['magnet', 'magnet_url', 'magnet_link'])) {
                    $ç£åŠ›å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['ed2k', 'ed2k_url', 'ed2k_link'])) {
                    $ç”µé©´å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['pic', 'image', 'cover', 'vod_pic', 'poster'])) {
                    $å›¾ç‰‡å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['desc', 'description', 'content', 'vod_content'])) {
                    $æè¿°å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['year', 'vod_year'])) {
                    $å¹´ä»½å­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['area', 'region', 'vod_area'])) {
                    $åœ°åŒºå­—æ®µ = $å­—æ®µ;
                } elseif (in_array($å°å†™å­—æ®µ, ['json', 'data', 'vod_data'])) {
                    $JSONå­—æ®µ = $å­—æ®µ;
                }
            }
            
            if ($åç§°å­—æ®µ) {
                $é€‰æ‹©å­—æ®µ = [$åç§°å­—æ®µ];
                if ($é“¾æ¥å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $é“¾æ¥å­—æ®µ;
                if ($ç£åŠ›å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $ç£åŠ›å­—æ®µ;
                if ($ç”µé©´å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $ç”µé©´å­—æ®µ;
                if ($å›¾ç‰‡å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $å›¾ç‰‡å­—æ®µ;
                if ($æè¿°å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $æè¿°å­—æ®µ;
                if ($å¹´ä»½å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $å¹´ä»½å­—æ®µ;
                if ($åœ°åŒºå­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $åœ°åŒºå­—æ®µ;
                if ($JSONå­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $JSONå­—æ®µ;
                
                $æŸ¥è¯¢SQL = "SELECT " . implode(', ', $é€‰æ‹©å­—æ®µ) . " FROM $è¡¨å LIMIT " . MAX_DB_RESULTS;
                
                $è¯­å¥ = $æ•°æ®åº“->query($æŸ¥è¯¢SQL);
                $ç»“æœé›† = $è¯­å¥->fetchAll(PDO::FETCH_ASSOC);
                
                foreach ($ç»“æœé›† as $ç´¢å¼• => $è¡Œæ•°æ®) {
                    $è§†é¢‘åç§° = $è¡Œæ•°æ®[$åç§°å­—æ®µ] ?? 'æœªçŸ¥è§†é¢‘';
                    
                    if ($JSONå­—æ®µ && !empty($è¡Œæ•°æ®[$JSONå­—æ®µ])) {
                        $jsonæ•°æ® = json_decode($è¡Œæ•°æ®[$JSONå­—æ®µ], true);
                        if ($jsonæ•°æ® && is_array($jsonæ•°æ®)) {
                            if (isset($jsonæ•°æ®['name']) && empty($è§†é¢‘åç§°)) {
                                $è§†é¢‘åç§° = $jsonæ•°æ®['name'];
                            }
                        }
                    }
                    
                    $è§†é¢‘é“¾æ¥ = '';
                    $æ’­æ”¾æ¥æº = 'æ•°æ®åº“æº';
                    
                    if ($ç£åŠ›å­—æ®µ && !empty($è¡Œæ•°æ®[$ç£åŠ›å­—æ®µ])) {
                        $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®[$ç£åŠ›å­—æ®µ];
                        $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                    } elseif ($ç”µé©´å­—æ®µ && !empty($è¡Œæ•°æ®[$ç”µé©´å­—æ®µ])) {
                        $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®[$ç”µé©´å­—æ®µ];
                        $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
                    } elseif ($é“¾æ¥å­—æ®µ && !empty($è¡Œæ•°æ®[$é“¾æ¥å­—æ®µ])) {
                        $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®[$é“¾æ¥å­—æ®µ];
                        if (strpos($è§†é¢‘é“¾æ¥, 'magnet:') === 0) {
                            $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                        } elseif (strpos($è§†é¢‘é“¾æ¥, 'ed2k://') === 0) {
                            $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
                        }
                    }
                    
                    if (empty($è§†é¢‘é“¾æ¥)) {
                        continue;
                    }
                    
                    $è§†é¢‘å°é¢ = $è¡Œæ•°æ®[$å›¾ç‰‡å­—æ®µ] ?? $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)];
                    $è§†é¢‘æè¿° = $è¡Œæ•°æ®[$æè¿°å­—æ®µ] ?? 'ã€Š' . $è§†é¢‘åç§° . 'ã€‹çš„ç²¾å½©å†…å®¹';
                    $è§†é¢‘å¹´ä»½ = $è¡Œæ•°æ®[$å¹´ä»½å­—æ®µ] ?? date('Y');
                    $è§†é¢‘åœ°åŒº = $è¡Œæ•°æ®[$åœ°åŒºå­—æ®µ] ?? 'ä¸­å›½å¤§é™†';
                    
                    $æœ‰æ•ˆåè®® = ['http://', 'https://', 'rtmp://', 'rtsp://', 'udp://', 'magnet:', 'ed2k://'];
                    $æœ‰æœ‰æ•ˆåè®® = false;
                    foreach ($æœ‰æ•ˆåè®® as $åè®®) {
                        if (stripos($è§†é¢‘é“¾æ¥, $åè®®) === 0) {
                            $æœ‰æœ‰æ•ˆåè®® = true;
                            break;
                        }
                    }
                    
                    if (!$æœ‰æœ‰æ•ˆåè®®) {
                        continue;
                    }
                    
                    $è§†é¢‘åˆ—è¡¨[] = [
                        'vod_id' => 'db_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $ç´¢å¼•,
                        'vod_name' => $è§†é¢‘åç§°,
                        'vod_pic' => $è§†é¢‘å°é¢,
                        'vod_remarks' => 'é«˜æ¸…',
                        'vod_year' => $è§†é¢‘å¹´ä»½,
                        'vod_area' => $è§†é¢‘åœ°åŒº,
                        'vod_content' => $è§†é¢‘æè¿°,
                        'vod_play_from' => $æ’­æ”¾æ¥æº,
                        'vod_play_url' => 'æ­£ç‰‡$' . $è§†é¢‘é“¾æ¥
                    ];
                    
                    if (count($è§†é¢‘åˆ—è¡¨) >= MAX_DB_RESULTS) {
                        break 2;
                    }
                }
            }
        }
    }
    
    $æ•°æ®åº“ = null;
    
    return $è§†é¢‘åˆ—è¡¨;
}
/**
 * è§£æé€šç”¨è§†é¢‘æ•°æ®åº“ - æ”¯æŒå¤§å¤šæ•°è§†é¢‘æ•°æ®åº“æ ¼å¼
 */
function è§£æé€šç”¨è§†é¢‘æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„) {
    global $DB_FIELD_MAPPING;
    
    $è§†é¢‘åˆ—è¡¨ = [];
    $è¡¨åˆ—è¡¨ = $æ•°æ®åº“->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662',
        'https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2640235365.jpg',
        'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2640235366.jpg'
    ];
    
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (strpos($è¡¨å, 'sqlite_') === 0) continue;
        
        // è·å–è¡¨ç»“æ„
        $å­—æ®µä¿¡æ¯ = $æ•°æ®åº“->query("PRAGMA table_info($è¡¨å)")->fetchAll(PDO::FETCH_ASSOC);
        $å­—æ®µåç§° = array_column($å­—æ®µä¿¡æ¯, 'name');
        
        // æ˜ å°„å­—æ®µ
        $æ˜ å°„å­—æ®µ = [];
        foreach ($DB_FIELD_MAPPING as $æ ‡å‡†å­—æ®µ => $å¯èƒ½å­—æ®µ) {
            foreach ($å¯èƒ½å­—æ®µ as $å€™é€‰å­—æ®µ) {
                if (in_array($å€™é€‰å­—æ®µ, $å­—æ®µåç§°)) {
                    $æ˜ å°„å­—æ®µ[$æ ‡å‡†å­—æ®µ] = $å€™é€‰å­—æ®µ;
                    break;
                }
            }
        }
        
        if (empty($æ˜ å°„å­—æ®µ['name']) || (empty($æ˜ å°„å­—æ®µ['url']) && empty($æ˜ å°„å­—æ®µ['magnet']))) {
            continue; // è·³è¿‡æ²¡æœ‰åç§°å’Œé“¾æ¥çš„è¡¨
        }
        
        // æ„å»ºæŸ¥è¯¢
        $é€‰æ‹©å­—æ®µ = array_values($æ˜ å°„å­—æ®µ);
        $æŸ¥è¯¢SQL = "SELECT " . implode(', ', $é€‰æ‹©å­—æ®µ) . " FROM $è¡¨å LIMIT " . MAX_DB_RESULTS;
        
        try {
            $è¯­å¥ = $æ•°æ®åº“->query($æŸ¥è¯¢SQL);
            $ç»“æœé›† = $è¯­å¥->fetchAll(PDO::FETCH_ASSOC);
            
            foreach ($ç»“æœé›† as $ç´¢å¼• => $è¡Œæ•°æ®) {
                $è§†é¢‘åç§° = $è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['name']] ?? 'æœªçŸ¥è§†é¢‘';
                $è§†é¢‘é“¾æ¥ = '';
                $æ’­æ”¾æ¥æº = 'æ•°æ®åº“æº';
                
                // ä¼˜å…ˆä½¿ç”¨ç£åŠ›é“¾æ¥
                if (!empty($æ˜ å°„å­—æ®µ['magnet']) && !empty($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['magnet']])) {
                    $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['magnet']];
                    $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                } elseif (!empty($æ˜ å°„å­—æ®µ['url']) && !empty($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['url']])) {
                    $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['url']];
                    if (strpos($è§†é¢‘é“¾æ¥, 'magnet:') === 0) {
                        $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                    } elseif (strpos($è§†é¢‘é“¾æ¥, 'ed2k://') === 0) {
                        $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
                    } elseif (strpos($è§†é¢‘é“¾æ¥, 'http') === 0) {
                        $æ’­æ”¾æ¥æº = 'åœ¨çº¿æ’­æ”¾';
                    }
                }
                
                if (empty($è§†é¢‘é“¾æ¥)) {
                    continue;
                }
                
                // æ„å»ºè§†é¢‘ä¿¡æ¯
                $è§†é¢‘å°é¢ = '';
                if (!empty($æ˜ å°„å­—æ®µ['image']) && !empty($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['image']])) {
                    $è§†é¢‘å°é¢ = $è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['image']];
                } else {
                    $è§†é¢‘å°é¢ = $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)];
                }
                
                $è§†é¢‘ä¿¡æ¯ = [
                    'vod_id' => 'db_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $ç´¢å¼•,
                    'vod_name' => $è§†é¢‘åç§°,
                    'vod_pic' => $è§†é¢‘å°é¢,
                    'vod_remarks' => 'é«˜æ¸…',
                    'vod_year' => !empty($æ˜ å°„å­—æ®µ['year']) ? ($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['year']] ?? date('Y')) : date('Y'),
                    'vod_area' => !empty($æ˜ å°„å­—æ®µ['area']) ? ($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['area']] ?? 'ä¸­å›½å¤§é™†') : 'ä¸­å›½å¤§é™†',
                    'vod_content' => !empty($æ˜ å°„å­—æ®µ['content']) ? ($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['content']] ?? $è§†é¢‘åç§° . 'çš„ç²¾å½©å†…å®¹') : $è§†é¢‘åç§° . 'çš„ç²¾å½©å†…å®¹',
                    'vod_play_from' => $æ’­æ”¾æ¥æº,
                    'vod_play_url' => 'æ­£ç‰‡$' . $è§†é¢‘é“¾æ¥
                ];
                
                // æ·»åŠ å¯é€‰å­—æ®µ
                if (!empty($æ˜ å°„å­—æ®µ['actor']) && !empty($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['actor']])) {
                    $è§†é¢‘ä¿¡æ¯['vod_actor'] = $è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['actor']];
                }
                
                if (!empty($æ˜ å°„å­—æ®µ['director']) && !empty($è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['director']])) {
                    $è§†é¢‘ä¿¡æ¯['vod_director'] = $è¡Œæ•°æ®[$æ˜ å°„å­—æ®µ['director']];
                }
                
                $è§†é¢‘åˆ—è¡¨[] = $è§†é¢‘ä¿¡æ¯;
                
                if (count($è§†é¢‘åˆ—è¡¨) >= MAX_DB_RESULTS) {
                    break 2;
                }
            }
        } catch (Exception $e) {
            // è·³è¿‡æœ‰é—®é¢˜çš„è¡¨
            continue;
        }
    }
    
    $æ•°æ®åº“ = null;
    return $è§†é¢‘åˆ—è¡¨;
}

/**
 * è§£æç›´æ’­é¢‘é“æ•°æ®åº“
 */
function è§£æç›´æ’­é¢‘é“æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„) {
    $è§†é¢‘åˆ—è¡¨ = [];
    $è¡¨åˆ—è¡¨ = $æ•°æ®åº“->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662'
    ];
    
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (strpos($è¡¨å, 'sqlite_') === 0) continue;
        
        $å­—æ®µä¿¡æ¯ = $æ•°æ®åº“->query("PRAGMA table_info($è¡¨å)")->fetchAll(PDO::FETCH_ASSOC);
        $å­—æ®µåç§° = array_column($å­—æ®µä¿¡æ¯, 'name');
        
        $åç§°å­—æ®µ = null;
        $é“¾æ¥å­—æ®µ = null;
        $åˆ†ç»„å­—æ®µ = null;
        $å›¾æ ‡å­—æ®µ = null;
        
        foreach ($å­—æ®µåç§° as $å­—æ®µ) {
            $å°å†™å­—æ®µ = strtolower($å­—æ®µ);
            if (in_array($å°å†™å­—æ®µ, ['name', 'title', 'channel_name', 'channel_title'])) {
                $åç§°å­—æ®µ = $å­—æ®µ;
            } elseif (in_array($å°å†™å­—æ®µ, ['url', 'link', 'channel_url', 'play_url'])) {
                $é“¾æ¥å­—æ®µ = $å­—æ®µ;
            } elseif (in_array($å°å†™å­—æ®µ, ['group', 'category', 'type'])) {
                $åˆ†ç»„å­—æ®µ = $å­—æ®µ;
            } elseif (in_array($å°å†™å­—æ®µ, ['logo', 'icon', 'image'])) {
                $å›¾æ ‡å­—æ®µ = $å­—æ®µ;
            }
        }
        
        if (!$åç§°å­—æ®µ || !$é“¾æ¥å­—æ®µ) {
            continue;
        }
        
        $é€‰æ‹©å­—æ®µ = [$åç§°å­—æ®µ, $é“¾æ¥å­—æ®µ];
        if ($åˆ†ç»„å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $åˆ†ç»„å­—æ®µ;
        if ($å›¾æ ‡å­—æ®µ) $é€‰æ‹©å­—æ®µ[] = $å›¾æ ‡å­—æ®µ;
        
        $æŸ¥è¯¢SQL = "SELECT " . implode(', ', $é€‰æ‹©å­—æ®µ) . " FROM $è¡¨å LIMIT 1000";
        
        try {
            $è¯­å¥ = $æ•°æ®åº“->query($æŸ¥è¯¢SQL);
            $ç»“æœé›† = $è¯­å¥->fetchAll(PDO::FETCH_ASSOC);
            
            foreach ($ç»“æœé›† as $ç´¢å¼• => $è¡Œæ•°æ®) {
                $é¢‘é“åç§° = $è¡Œæ•°æ®[$åç§°å­—æ®µ] ?? 'æœªçŸ¥é¢‘é“';
                $é¢‘é“é“¾æ¥ = $è¡Œæ•°æ®[$é“¾æ¥å­—æ®µ] ?? '';
                $é¢‘é“åˆ†ç»„ = $åˆ†ç»„å­—æ®µ ? ($è¡Œæ•°æ®[$åˆ†ç»„å­—æ®µ] ?? 'ç›´æ’­é¢‘é“') : 'ç›´æ’­é¢‘é“';
                $é¢‘é“å›¾æ ‡ = $å›¾æ ‡å­—æ®µ ? ($è¡Œæ•°æ®[$å›¾æ ‡å­—æ®µ] ?? '') : '';
                
                if (empty($é¢‘é“é“¾æ¥)) {
                    continue;
                }
                
                $è§†é¢‘å°é¢ = $é¢‘é“å›¾æ ‡ ?: $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)];
                
                $è§†é¢‘åˆ—è¡¨[] = [
                    'vod_id' => 'live_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $ç´¢å¼•,
                    'vod_name' => $é¢‘é“åç§°,
                    'vod_pic' => $è§†é¢‘å°é¢,
                    'vod_remarks' => 'ç›´æ’­',
                    'vod_year' => date('Y'),
                    'vod_area' => 'ä¸­å›½å¤§é™†',
                    'vod_content' => $é¢‘é“åç§° . 'ç›´æ’­é¢‘é“',
                    'vod_play_from' => $é¢‘é“åˆ†ç»„,
                    'vod_play_url' => 'ç›´æ’­$' . $é¢‘é“é“¾æ¥
                ];
                
                if (count($è§†é¢‘åˆ—è¡¨) >= 1000) {
                    break 2;
                }
            }
        } catch (Exception $e) {
            continue;
        }
    }
    
    $æ•°æ®åº“ = null;
    return $è§†é¢‘åˆ—è¡¨;
}

/**
 * è‡ªåŠ¨è¯†åˆ«å¹¶è§£ææ•°æ®åº“
 */
function è§£æè‡ªåŠ¨è¯†åˆ«æ•°æ®åº“($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„, $è¡¨åˆ—è¡¨) {
    $è§†é¢‘åˆ—è¡¨ = [];
    
    // å°è¯•å¤šç§è§£ææ–¹å¼
    foreach ($è¡¨åˆ—è¡¨ as $è¡¨å) {
        if (strpos($è¡¨å, 'sqlite_') === 0) continue;
        
        // æ–¹æ³•1: æ£€æŸ¥æ˜¯å¦æœ‰å¸¸è§çš„è§†é¢‘å­—æ®µ
        $è§†é¢‘åˆ—è¡¨ = array_merge($è§†é¢‘åˆ—è¡¨, å°è¯•è§£æé€šç”¨è¡¨($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„, $è¡¨å));
        
        // æ–¹æ³•2: æ£€æŸ¥æ˜¯å¦æœ‰JSONæ•°æ®å­—æ®µ
        $è§†é¢‘åˆ—è¡¨ = array_merge($è§†é¢‘åˆ—è¡¨, å°è¯•è§£æJSONè¡¨($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„, $è¡¨å));
        
        if (count($è§†é¢‘åˆ—è¡¨) >= MAX_DB_RESULTS) {
            break;
        }
    }
    
    $æ•°æ®åº“ = null;
    return $è§†é¢‘åˆ—è¡¨;
}

/**
 * å°è¯•è§£æé€šç”¨è¡¨ç»“æ„
 */
function å°è¯•è§£æé€šç”¨è¡¨($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„, $è¡¨å) {
    $è§†é¢‘åˆ—è¡¨ = [];
    
    try {
        $å­—æ®µä¿¡æ¯ = $æ•°æ®åº“->query("PRAGMA table_info($è¡¨å)")->fetchAll(PDO::FETCH_ASSOC);
        $å­—æ®µåç§° = array_column($å­—æ®µä¿¡æ¯, 'name');
        
        // æŸ¥æ‰¾å¯èƒ½çš„åç§°å’Œé“¾æ¥å­—æ®µ
        $å¯èƒ½åç§°å­—æ®µ = [];
        $å¯èƒ½é“¾æ¥å­—æ®µ = [];
        
        foreach ($å­—æ®µåç§° as $å­—æ®µ) {
            $å°å†™å­—æ®µ = strtolower($å­—æ®µ);
            if (strpos($å°å†™å­—æ®µ, 'name') !== false || strpos($å°å†™å­—æ®µ, 'title') !== false) {
                $å¯èƒ½åç§°å­—æ®µ[] = $å­—æ®µ;
            }
            if (strpos($å°å†™å­—æ®µ, 'url') !== false || strpos($å°å†™å­—æ®µ, 'link') !== false || 
                strpos($å°å†™å­—æ®µ, 'magnet') !== false) {
                $å¯èƒ½é“¾æ¥å­—æ®µ[] = $å­—æ®µ;
            }
        }
        
        if (empty($å¯èƒ½åç§°å­—æ®µ) || empty($å¯èƒ½é“¾æ¥å­—æ®µ)) {
            return $è§†é¢‘åˆ—è¡¨;
        }
        
        $åç§°å­—æ®µ = $å¯èƒ½åç§°å­—æ®µ[0];
        $é“¾æ¥å­—æ®µ = $å¯èƒ½é“¾æ¥å­—æ®µ[0];
        
        $æŸ¥è¯¢SQL = "SELECT $åç§°å­—æ®µ, $é“¾æ¥å­—æ®µ FROM $è¡¨å LIMIT 500";
        $è¯­å¥ = $æ•°æ®åº“->query($æŸ¥è¯¢SQL);
        $ç»“æœé›† = $è¯­å¥->fetchAll(PDO::FETCH_ASSOC);
        
        $é»˜è®¤å›¾ç‰‡ = ['https://www.252035.xyz/imgs?t=1335527662'];
        
        foreach ($ç»“æœé›† as $ç´¢å¼• => $è¡Œæ•°æ®) {
            $è§†é¢‘åç§° = $è¡Œæ•°æ®[$åç§°å­—æ®µ] ?? 'æœªçŸ¥è§†é¢‘';
            $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®[$é“¾æ¥å­—æ®µ] ?? '';
            
            if (empty($è§†é¢‘é“¾æ¥)) {
                continue;
            }
            
            $æ’­æ”¾æ¥æº = 'æ•°æ®åº“æº';
            if (strpos($è§†é¢‘é“¾æ¥, 'magnet:') === 0) {
                $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
            } elseif (strpos($è§†é¢‘é“¾æ¥, 'ed2k://') === 0) {
                $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
            }
            
            $è§†é¢‘åˆ—è¡¨[] = [
                'vod_id' => 'auto_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $ç´¢å¼•,
                'vod_name' => $è§†é¢‘åç§°,
                'vod_pic' => $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)],
                'vod_remarks' => 'é«˜æ¸…',
                'vod_year' => date('Y'),
                'vod_area' => 'ä¸­å›½å¤§é™†',
                'vod_content' => $è§†é¢‘åç§° . 'çš„ç²¾å½©å†…å®¹',
                'vod_play_from' => $æ’­æ”¾æ¥æº,
                'vod_play_url' => 'æ­£ç‰‡$' . $è§†é¢‘é“¾æ¥
            ];
        }
    } catch (Exception $e) {
        // è·³è¿‡è§£æå¤±è´¥çš„è¡¨
    }
    
    return $è§†é¢‘åˆ—è¡¨;
}

/**
 * å°è¯•è§£æJSONè¡¨
 */
function å°è¯•è§£æJSONè¡¨($æ•°æ®åº“, $æ–‡ä»¶è·¯å¾„, $è¡¨å) {
    $è§†é¢‘åˆ—è¡¨ = [];
    
    try {
        $å­—æ®µä¿¡æ¯ = $æ•°æ®åº“->query("PRAGMA table_info($è¡¨å)")->fetchAll(PDO::FETCH_ASSOC);
        $å­—æ®µåç§° = array_column($å­—æ®µä¿¡æ¯, 'name');
        
        // æŸ¥æ‰¾å¯èƒ½çš„JSONå­—æ®µ
        $JSONå­—æ®µ = null;
        foreach ($å­—æ®µåç§° as $å­—æ®µ) {
            $å°å†™å­—æ®µ = strtolower($å­—æ®µ);
            if (in_array($å°å†™å­—æ®µ, ['json', 'data', 'info', 'content'])) {
                $JSONå­—æ®µ = $å­—æ®µ;
                break;
            }
        }
        
        if (!$JSONå­—æ®µ) {
            return $è§†é¢‘åˆ—è¡¨;
        }
        
        $æŸ¥è¯¢SQL = "SELECT $JSONå­—æ®µ FROM $è¡¨å LIMIT 300";
        $è¯­å¥ = $æ•°æ®åº“->query($æŸ¥è¯¢SQL);
        $ç»“æœé›† = $è¯­å¥->fetchAll(PDO::FETCH_COLUMN);
        
        $é»˜è®¤å›¾ç‰‡ = ['https://www.252035.xyz/imgs?t=1335527662'];
        
        foreach ($ç»“æœé›† as $ç´¢å¼• => $jsonæ•°æ®) {
            if (empty($jsonæ•°æ®)) continue;
            
            $è§†é¢‘æ•°æ® = json_decode($jsonæ•°æ®, true);
            if (!$è§†é¢‘æ•°æ® || !is_array($è§†é¢‘æ•°æ®)) continue;
            
            $è§†é¢‘åç§° = $è§†é¢‘æ•°æ®['title'] ?? $è§†é¢‘æ•°æ®['name'] ?? 'æœªçŸ¥è§†é¢‘';
            $è§†é¢‘é“¾æ¥ = $è§†é¢‘æ•°æ®['url'] ?? $è§†é¢‘æ•°æ®['magnet'] ?? $è§†é¢‘æ•°æ®['link'] ?? '';
            
            if (empty($è§†é¢‘é“¾æ¥)) continue;
            
            $æ’­æ”¾æ¥æº = 'æ•°æ®åº“æº';
            if (strpos($è§†é¢‘é“¾æ¥, 'magnet:') === 0) {
                $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
            } elseif (strpos($è§†é¢‘é“¾æ¥, 'ed2k://') === 0) {
                $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
            }
            
            $è§†é¢‘åˆ—è¡¨[] = [
                'vod_id' => 'json_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $ç´¢å¼•,
                'vod_name' => $è§†é¢‘åç§°,
                'vod_pic' => $è§†é¢‘æ•°æ®['image'] ?? $è§†é¢‘æ•°æ®['pic'] ?? $è§†é¢‘æ•°æ®['cover'] ?? $é»˜è®¤å›¾ç‰‡[$ç´¢å¼• % count($é»˜è®¤å›¾ç‰‡)],
                'vod_remarks' => 'é«˜æ¸…',
                'vod_year' => $è§†é¢‘æ•°æ®['year'] ?? date('Y'),
                'vod_area' => $è§†é¢‘æ•°æ®['area'] ?? 'ä¸­å›½å¤§é™†',
                'vod_content' => $è§†é¢‘æ•°æ®['desc'] ?? $è§†é¢‘æ•°æ®['description'] ?? $è§†é¢‘æ•°æ®['content'] ?? $è§†é¢‘åç§° . 'çš„ç²¾å½©å†…å®¹',
                'vod_play_from' => $æ’­æ”¾æ¥æº,
                'vod_play_url' => 'æ­£ç‰‡$' . $è§†é¢‘é“¾æ¥
            ];
            
            if (count($è§†é¢‘åˆ—è¡¨) >= 300) {
                break;
            }
        }
    } catch (Exception $e) {
        // è·³è¿‡è§£æå¤±è´¥çš„è¡¨
    }
    
    return $è§†é¢‘åˆ—è¡¨;
}
/**
 * è§£æJSONæ–‡ä»¶å†…å®¹ - å®Œæ•´åŠ è½½
 */
function è§£æJSONæ–‡ä»¶($æ–‡ä»¶è·¯å¾„) {
    if (!file_exists($æ–‡ä»¶è·¯å¾„)) {
        return ['é”™è¯¯' => 'JSONæ–‡ä»¶ä¸å­˜åœ¨: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    $JSONå†…å®¹ = @file_get_contents($æ–‡ä»¶è·¯å¾„);
    if ($JSONå†…å®¹ === false) {
        return ['é”™è¯¯' => 'æ— æ³•è¯»å–JSONæ–‡ä»¶: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    if (substr($JSONå†…å®¹, 0, 3) == "\xEF\xBB\xBF") {
        $JSONå†…å®¹ = substr($JSONå†…å®¹, 3);
    }
    
    $æ•°æ® = json_decode($JSONå†…å®¹, true);
    if (!$æ•°æ®) {
        return ['é”™è¯¯' => 'JSONæ ¼å¼æ— æ•ˆ: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    if (!isset($æ•°æ®['list']) || !is_array($æ•°æ®['list'])) {
        return ['é”™è¯¯' => 'JSONæ ¼å¼æ— æ•ˆæˆ–ç¼ºå°‘listå­—æ®µ: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    return $æ•°æ®['list'];
}

/**
 * æ™ºèƒ½ç”Ÿæˆè§†é¢‘åç§°
 */
function ç”Ÿæˆè§†é¢‘åç§°($é“¾æ¥, $é»˜è®¤åç§° = 'æœªçŸ¥è§†é¢‘') {
    if (strpos($é“¾æ¥, 'magnet:?xt=urn:btih:') === 0) {
        if (preg_match('/&dn=([^&]+)/i', $é“¾æ¥, $åŒ¹é…)) {
            $åç§° = urldecode($åŒ¹é…[1]);
            return $åç§° ?: 'ç£åŠ›èµ„æº';
        }
        return 'ç£åŠ›èµ„æº';
    }
    
    if (strpos($é“¾æ¥, 'ed2k://') === 0) {
        if (preg_match('/\|file\|([^\|]+)\|/i', $é“¾æ¥, $åŒ¹é…)) {
            $åç§° = urldecode($åŒ¹é…[1]);
            return $åç§° ?: 'ç”µé©´èµ„æº';
        }
        return 'ç”µé©´èµ„æº';
    }
    
    return $é»˜è®¤åç§°;
}

/**
 * è§£æTXTæ–‡ä»¶å†…å®¹ - å¢å¼ºç£åŠ›é“¾æ¥å’Œçº¯é“¾æ¥æ”¯æŒ
 */
function è§£æTXTæ–‡ä»¶($æ–‡ä»¶è·¯å¾„) {
    if (!file_exists($æ–‡ä»¶è·¯å¾„)) {
        return ['é”™è¯¯' => 'TXTæ–‡ä»¶ä¸å­˜åœ¨: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    $å¥æŸ„ = @fopen($æ–‡ä»¶è·¯å¾„, 'r');
    if (!$å¥æŸ„) {
        return ['é”™è¯¯' => 'æ— æ³•æ‰“å¼€TXTæ–‡ä»¶: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    $è§†é¢‘åˆ—è¡¨ = [];
    $è§†é¢‘æ•°é‡ = 0;
    $è¡Œå· = 0;
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662'
    ];
    
    $é¦–è¡Œ = fgets($å¥æŸ„);
    rewind($å¥æŸ„);
    $æœ‰BOM = (substr($é¦–è¡Œ, 0, 3) == "\xEF\xBB\xBF");
    if ($æœ‰BOM) {
        fseek($å¥æŸ„, 3);
    }
    
    $å†…å­˜é™åˆ¶ = 50 * 1024 * 1024;
    $èµ·å§‹å†…å­˜ = memory_get_usage();
    
    while (($è¡Œ = fgets($å¥æŸ„)) !== false) {
        $è¡Œå·++;
        $è¡Œ = trim($è¡Œ);
        
        if ($è¡Œ === '' || $è¡Œ[0] === '#' || $è¡Œ[0] === ';') {
            continue;
        }
        
        if (strpos($è¡Œ, 'magnet:') === 0 || strpos($è¡Œ, 'ed2k://') === 0) {
            $é“¾æ¥ = $è¡Œ;
            $åç§° = ç”Ÿæˆè§†é¢‘åç§°($é“¾æ¥);
        } else {
            $åˆ†éš”ç¬¦ = [',', "\t", '|', '$', '#'];
            $åˆ†éš”ç¬¦ä½ç½® = false;
            
            foreach ($åˆ†éš”ç¬¦ as $åˆ†éš”) {
                $ä½ç½® = strpos($è¡Œ, $åˆ†éš”);
                if ($ä½ç½® !== false) {
                    $åˆ†éš”ç¬¦ä½ç½® = $ä½ç½®;
                    break;
                }
            }
            
            if ($åˆ†éš”ç¬¦ä½ç½® === false) {
                $é“¾æ¥ = $è¡Œ;
                $åç§° = ç”Ÿæˆè§†é¢‘åç§°($é“¾æ¥);
            } else {
                $åç§° = trim(substr($è¡Œ, 0, $åˆ†éš”ç¬¦ä½ç½®));
                $é“¾æ¥ = trim(substr($è¡Œ, $åˆ†éš”ç¬¦ä½ç½® + 1));
            }
        }
        
        if (empty($åç§°) || empty($é“¾æ¥)) {
            continue;
        }
        
        $æœ‰æ•ˆåè®® = ['http://', 'https://', 'rtmp://', 'rtsp://', 'udp://', 'magnet:', 'ed2k://'];
        $æœ‰æœ‰æ•ˆåè®® = false;
        foreach ($æœ‰æ•ˆåè®® as $åè®®) {
            if (stripos($é“¾æ¥, $åè®®) === 0) {
                $æœ‰æœ‰æ•ˆåè®® = true;
                break;
            }
        }
        
        if (!$æœ‰æœ‰æ•ˆåè®®) {
            continue;
        }
        
        $å›¾ç‰‡ç´¢å¼• = $è§†é¢‘æ•°é‡ % count($é»˜è®¤å›¾ç‰‡);
        
        $æ’­æ”¾æ¥æº = 'åœ¨çº¿æ’­æ”¾';
        if (strpos($é“¾æ¥, 'magnet:') === 0) {
            $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
        } elseif (strpos($é“¾æ¥, 'ed2k://') === 0) {
            $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
        }
        
        $è§†é¢‘åˆ—è¡¨[] = [
            'vod_id' => 'txt_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡Œå·,
            'vod_name' => $åç§°,
            'vod_pic' => $é»˜è®¤å›¾ç‰‡[$å›¾ç‰‡ç´¢å¼•],
            'vod_remarks' => 'é«˜æ¸…',
            'vod_year' => date('Y'),
            'vod_area' => 'ä¸­å›½å¤§é™†',
            'vod_content' => 'ã€Š' . $åç§° . 'ã€‹çš„ç²¾å½©å†…å®¹',
            'vod_play_from' => $æ’­æ”¾æ¥æº,
            'vod_play_url' => 'æ­£ç‰‡$' . $é“¾æ¥
        ];
        
        $è§†é¢‘æ•°é‡++;
        
        if ($è§†é¢‘æ•°é‡ % 100 === 0) {
            $å½“å‰å†…å­˜ = memory_get_usage() - $èµ·å§‹å†…å­˜;
            if ($å½“å‰å†…å­˜ > $å†…å­˜é™åˆ¶) {
                break;
            }
            gc_collect_cycles();
        }
        
        if ($è§†é¢‘æ•°é‡ >= 10000) {
            break;
        }
    }
    
    fclose($å¥æŸ„);
    
    return $è§†é¢‘åˆ—è¡¨;
}

/**
 * è§£æM3Uæ–‡ä»¶å†…å®¹ - å¢å¼ºç£åŠ›é“¾æ¥æ”¯æŒ
 */
function è§£æM3Uæ–‡ä»¶($æ–‡ä»¶è·¯å¾„) {
    if (!file_exists($æ–‡ä»¶è·¯å¾„)) {
        return ['é”™è¯¯' => 'M3Uæ–‡ä»¶ä¸å­˜åœ¨: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    $å¥æŸ„ = @fopen($æ–‡ä»¶è·¯å¾„, 'r');
    if (!$å¥æŸ„) {
        return ['é”™è¯¯' => 'æ— æ³•æ‰“å¼€M3Uæ–‡ä»¶: ' . basename($æ–‡ä»¶è·¯å¾„)];
    }
    
    $è§†é¢‘åˆ—è¡¨ = [];
    $è§†é¢‘æ•°é‡ = 0;
    $å½“å‰åç§° = '';
    $å½“å‰å›¾æ ‡ = '';
    $å½“å‰åˆ†ç»„ = '';
    $è¡Œå· = 0;
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662'
    ];
    
    $é¦–è¡Œ = fgets($å¥æŸ„);
    rewind($å¥æŸ„);
    $æœ‰BOM = (substr($é¦–è¡Œ, 0, 3) == "\xEF\xBB\xBF");
    if ($æœ‰BOM) {
        fseek($å¥æŸ„, 3);
    }
    
    while (($è¡Œ = fgets($å¥æŸ„)) !== false) {
        $è¡Œå·++;
        $è¡Œ = trim($è¡Œ);
        if ($è¡Œ === '') continue;
        
        if (strpos($è¡Œ, '#EXTM3U') === 0) {
            continue;
        }
        
        if (strpos($è¡Œ, '#EXTINF:') === 0) {
            $å½“å‰åç§° = '';
            $å½“å‰å›¾æ ‡ = '';
            $å½“å‰åˆ†ç»„ = '';
            
            $éƒ¨åˆ† = explode(',', $è¡Œ, 2);
            if (count($éƒ¨åˆ†) > 1) {
                $å½“å‰åç§° = trim($éƒ¨åˆ†[1]);
            }
            
            if (preg_match('/tvg-logo="([^"]*)"/i', $è¡Œ, $å›¾æ ‡åŒ¹é…)) {
                $å½“å‰å›¾æ ‡ = trim($å›¾æ ‡åŒ¹é…[1]);
            }
            
            if (preg_match('/group-title="([^"]*)"/i', $è¡Œ, $åˆ†ç»„åŒ¹é…)) {
                $å½“å‰åˆ†ç»„ = trim($åˆ†ç»„åŒ¹é…[1]);
            }
            continue;
        }
        
        $æœ‰æ•ˆåè®® = ['http://', 'https://', 'rtmp://', 'rtsp://', 'udp://', 'magnet:', 'ed2k://'];
        $æœ‰æœ‰æ•ˆåè®® = false;
        foreach ($æœ‰æ•ˆåè®® as $åè®®) {
            if (stripos($è¡Œ, $åè®®) === 0) {
                $æœ‰æœ‰æ•ˆåè®® = true;
                break;
            }
        }
        
        if ($æœ‰æœ‰æ•ˆåè®® && !empty($å½“å‰åç§°)) {
            $å›¾ç‰‡ç´¢å¼• = $è§†é¢‘æ•°é‡ % count($é»˜è®¤å›¾ç‰‡);
            
            $è§†é¢‘å°é¢ = $å½“å‰å›¾æ ‡;
            if (empty($è§†é¢‘å°é¢) || !filter_var($è§†é¢‘å°é¢, FILTER_VALIDATE_URL)) {
                $è§†é¢‘å°é¢ = $é»˜è®¤å›¾ç‰‡[$å›¾ç‰‡ç´¢å¼•];
            }
            
            $æ’­æ”¾æ¥æº = 'ç›´æ’­æº';
            if (!empty($å½“å‰åˆ†ç»„)) {
                $æ’­æ”¾æ¥æº = $å½“å‰åˆ†ç»„;
            }
            
            if (strpos($è¡Œ, 'magnet:') === 0) {
                $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
            } elseif (strpos($è¡Œ, 'ed2k://') === 0) {
                $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
            }
            
            $è§†é¢‘åˆ—è¡¨[] = [
                'vod_id' => 'm3u_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡Œå·,
                'vod_name' => $å½“å‰åç§°,
                'vod_pic' => $è§†é¢‘å°é¢,
                'vod_remarks' => 'ç›´æ’­',
                'vod_year' => date('Y'),
                'vod_area' => 'ä¸­å›½å¤§é™†',
                'vod_content' => $å½“å‰åç§° . 'ç›´æ’­é¢‘é“',
                'vod_play_from' => $æ’­æ”¾æ¥æº,
                'vod_play_url' => 'ç›´æ’­$' . $è¡Œ
            ];
            
            $è§†é¢‘æ•°é‡++;
            
            $å½“å‰åç§° = '';
            $å½“å‰å›¾æ ‡ = '';
            $å½“å‰åˆ†ç»„ = '';
            
            if ($è§†é¢‘æ•°é‡ >= 5000) {
                break;
            }
        }
    }
    
    fclose($å¥æŸ„);
    
    return $è§†é¢‘åˆ—è¡¨;
}
/**
 * åˆ†ç±»åˆ—è¡¨
 */
function è·å–åˆ†ç±»($åˆ†ç±»æ ‡è¯†, $é¡µç ) {
    $åˆ†ç±»åˆ—è¡¨ = è·å–åˆ†ç±»åˆ—è¡¨();
    
    if (empty($åˆ†ç±»åˆ—è¡¨)) {
        return ['é”™è¯¯' => 'æœªæ‰¾åˆ°ä»»ä½•åˆ†ç±»'];
    }
    
    if ($åˆ†ç±»æ ‡è¯† === 'hot') {
        $å½“å‰é¡µç  = intval($é¡µç );
        if ($å½“å‰é¡µç  < 1) $å½“å‰é¡µç  = 1;
        
        $çƒ­é—¨è§†é¢‘ = è·å–çƒ­é—¨è§†é¢‘($å½“å‰é¡µç , 15);
        
        if (empty($çƒ­é—¨è§†é¢‘)) {
            return [
                'page' => $å½“å‰é¡µç ,
                'pagecount' => 9999,
                'limit' => 15,
                'total' => 0,
                'list' => []
            ];
        }
        
        $æ ¼å¼åŒ–è§†é¢‘ = [];
        foreach ($çƒ­é—¨è§†é¢‘ as $è§†é¢‘) {
            $æ ¼å¼åŒ–è§†é¢‘[] = æ ¼å¼åŒ–è§†é¢‘é¡¹($è§†é¢‘);
        }
        
        return [
            'page' => $å½“å‰é¡µç ,
            'pagecount' => 9999,
            'limit' => 15,
            'total' => 999999,
            'list' => $æ ¼å¼åŒ–è§†é¢‘
        ];
    }
    
    $ç›®æ ‡åˆ†ç±» = null;
    foreach ($åˆ†ç±»åˆ—è¡¨ as $åˆ†ç±») {
        if ($åˆ†ç±»['type_id'] === $åˆ†ç±»æ ‡è¯†) {
            $ç›®æ ‡åˆ†ç±» = $åˆ†ç±»;
            break;
        }
    }
    
    if (!$ç›®æ ‡åˆ†ç±») {
        return ['é”™è¯¯' => 'åˆ†ç±»æœªæ‰¾åˆ°: ' . $åˆ†ç±»æ ‡è¯†];
    }
    
    if ($ç›®æ ‡åˆ†ç±»['source_type'] === 'empty') {
        return [
            'page' => 1,
            'pagecount' => 1,
            'limit' => 10,
            'total' => 0,
            'list' => []
        ];
    }
    
    $åˆ†ç±»è§†é¢‘ = [];
    
    if (file_exists($ç›®æ ‡åˆ†ç±»['source_path'])) {
        switch ($ç›®æ ‡åˆ†ç±»['source_type']) {
            case 'json':
                $åˆ†ç±»è§†é¢‘ = è§£æJSONæ–‡ä»¶($ç›®æ ‡åˆ†ç±»['source_path']);
                break;
            case 'txt':
                $åˆ†ç±»è§†é¢‘ = è§£æTXTæ–‡ä»¶($ç›®æ ‡åˆ†ç±»['source_path']);
                break;
            case 'm3u':
                $åˆ†ç±»è§†é¢‘ = è§£æM3Uæ–‡ä»¶($ç›®æ ‡åˆ†ç±»['source_path']);
                break;
            case 'db':
            case 'sqlite':
            case 'sqlite3':
            case 'db3':
                $åˆ†ç±»è§†é¢‘ = è§£ææ•°æ®åº“æ–‡ä»¶($ç›®æ ‡åˆ†ç±»['source_path']);
                break;
        }
    }
    
    if (isset($åˆ†ç±»è§†é¢‘['é”™è¯¯'])) {
        return ['é”™è¯¯' => $åˆ†ç±»è§†é¢‘['é”™è¯¯']];
    }
    
    if (empty($åˆ†ç±»è§†é¢‘)) {
        return ['é”™è¯¯' => 'åœ¨æ–‡ä»¶ä¸­æœªæ‰¾åˆ°è§†é¢‘: ' . $ç›®æ ‡åˆ†ç±»['type_name']];
    }
    
    $æ¯é¡µå¤§å° = 10;
    $æ€»æ•° = count($åˆ†ç±»è§†é¢‘);
    $æ€»é¡µæ•° = ceil($æ€»æ•° / $æ¯é¡µå¤§å°);
    $å½“å‰é¡µç  = intval($é¡µç );
    
    if ($å½“å‰é¡µç  < 1) $å½“å‰é¡µç  = 1;
    if ($å½“å‰é¡µç  > $æ€»é¡µæ•°) $å½“å‰é¡µç  = $æ€»é¡µæ•°;
    
    $èµ·å§‹ä½ç½® = ($å½“å‰é¡µç  - 1) * $æ¯é¡µå¤§å°;
    $åˆ†é¡µè§†é¢‘ = array_slice($åˆ†ç±»è§†é¢‘, $èµ·å§‹ä½ç½®, $æ¯é¡µå¤§å°);
    
    $æ ¼å¼åŒ–è§†é¢‘ = [];
    foreach ($åˆ†é¡µè§†é¢‘ as $è§†é¢‘) {
        $æ ¼å¼åŒ–è§†é¢‘[] = æ ¼å¼åŒ–è§†é¢‘é¡¹($è§†é¢‘);
    }
    
    return [
        'page' => $å½“å‰é¡µç ,
        'pagecount' => $æ€»é¡µæ•°,
        'limit' => $æ¯é¡µå¤§å°,
        'total' => $æ€»æ•°,
        'list' => $æ ¼å¼åŒ–è§†é¢‘
    ];
}

/**
 * æ ¼å¼åŒ–è§†é¢‘é¡¹
 */
function æ ¼å¼åŒ–è§†é¢‘é¡¹($è§†é¢‘) {
    return [
        'vod_id' => $è§†é¢‘['vod_id'] ?? '',
        'vod_name' => $è§†é¢‘['vod_name'] ?? 'æœªçŸ¥è§†é¢‘',
        'vod_pic' => $è§†é¢‘['vod_pic'] ?? 'https://www.252035.xyz/imgs?t=1335527662',
        'vod_remarks' => $è§†é¢‘['vod_remarks'] ?? 'é«˜æ¸…',
        'vod_year' => $è§†é¢‘['vod_year'] ?? '',
        'vod_area' => $è§†é¢‘['vod_area'] ?? 'ä¸­å›½å¤§é™†'
    ];
}

/**
 * è§†é¢‘è¯¦æƒ…
 */
function è·å–è¯¦æƒ…($è§†é¢‘æ ‡è¯†) {
    $æ ‡è¯†æ•°ç»„ = explode(',', $è§†é¢‘æ ‡è¯†);
    $ç»“æœ = [];
    
    foreach ($æ ‡è¯†æ•°ç»„ as $æ ‡è¯†) {
        $è§†é¢‘ = æŒ‰æ ‡è¯†æŸ¥æ‰¾è§†é¢‘($æ ‡è¯†);
        if ($è§†é¢‘) {
            $ç»“æœ[] = æ ¼å¼åŒ–è§†é¢‘è¯¦æƒ…($è§†é¢‘);
        } else {
            $ç»“æœ[] = [
                'vod_id' => $æ ‡è¯†,
                'vod_name' => 'è§†é¢‘ ' . $æ ‡è¯†,
                'vod_pic' => 'https://www.252035.xyz/imgs?t=1335527662',
                'vod_remarks' => 'é«˜æ¸…',
                'vod_content' => 'è§†é¢‘è¯¦æƒ…å†…å®¹',
                'vod_play_from' => 'åœ¨çº¿æ’­æ”¾',
                'vod_play_url' => 'æ­£ç‰‡$https://example.com/video'
            ];
        }
    }
    
    return ['list' => $ç»“æœ];
}

/**
 * æŒ‰æ ‡è¯†æŸ¥æ‰¾è§†é¢‘
 */
function æŒ‰æ ‡è¯†æŸ¥æ‰¾è§†é¢‘($æ ‡è¯†) {
    $æ‰€æœ‰æ–‡ä»¶ = è·å–æ‰€æœ‰æ–‡ä»¶();
    
    if (strpos($æ ‡è¯†, 'txt_') === 0) {
        $éƒ¨åˆ† = explode('_', $æ ‡è¯†);
        if (count($éƒ¨åˆ†) >= 3) {
            $æ–‡ä»¶å“ˆå¸Œ = $éƒ¨åˆ†[1];
            $è¡Œå· = $éƒ¨åˆ†[2];
            
            foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
                if ($æ–‡ä»¶['type'] === 'txt' && md5($æ–‡ä»¶['path']) === $æ–‡ä»¶å“ˆå¸Œ) {
                    return æŒ‰è¡ŒæŸ¥æ‰¾TXTè§†é¢‘($æ–‡ä»¶['path'], $è¡Œå·);
                }
            }
        }
    } elseif (strpos($æ ‡è¯†, 'm3u_') === 0) {
        $éƒ¨åˆ† = explode('_', $æ ‡è¯†);
        if (count($éƒ¨åˆ†) >= 3) {
            $æ–‡ä»¶å“ˆå¸Œ = $éƒ¨åˆ†[1];
            $è¡Œå· = $éƒ¨åˆ†[2];
            
            foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
                if ($æ–‡ä»¶['type'] === 'm3u' && md5($æ–‡ä»¶['path']) === $æ–‡ä»¶å“ˆå¸Œ) {
                    return æŒ‰è¡ŒæŸ¥æ‰¾M3Uè§†é¢‘($æ–‡ä»¶['path'], $è¡Œå·);
                }
            }
        }
    } elseif (strpos($æ ‡è¯†, 'db_') === 0) {
        $éƒ¨åˆ† = explode('_', $æ ‡è¯†);
        if (count($éƒ¨åˆ†) >= 4) {
            $æ–‡ä»¶å“ˆå¸Œ = $éƒ¨åˆ†[1];
            $è¡¨å = $éƒ¨åˆ†[2];
            $è§†é¢‘ç´¢å¼• = $éƒ¨åˆ†[3];
            
            foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
                if (in_array($æ–‡ä»¶['type'], ['db', 'sqlite', 'sqlite3', 'db3']) && md5($æ–‡ä»¶['path']) === $æ–‡ä»¶å“ˆå¸Œ) {
                    return æŒ‰ç´¢å¼•æŸ¥æ‰¾æ•°æ®åº“è§†é¢‘($æ–‡ä»¶['path'], $è¡¨å, $è§†é¢‘ç´¢å¼•);
                }
            }
        }
    } elseif (strpos($æ ‡è¯†, 'video_') === 0) {
        // è§†é¢‘åˆ†ç±»æ•°æ®åº“çš„è§†é¢‘æŸ¥æ‰¾
        $è§†é¢‘ID = substr($æ ‡è¯†, 6); // å»æ‰ 'video_' å‰ç¼€
        return æŒ‰IDæŸ¥æ‰¾åˆ†ç±»è§†é¢‘($è§†é¢‘ID);
    } elseif (strpos($æ ‡è¯†, 'auto_') === 0) {
        // è‡ªåŠ¨è¯†åˆ«æ•°æ®åº“çš„è§†é¢‘æŸ¥æ‰¾
        $éƒ¨åˆ† = explode('_', $æ ‡è¯†);
        if (count($éƒ¨åˆ†) >= 4) {
            $æ–‡ä»¶å“ˆå¸Œ = $éƒ¨åˆ†[1];
            $è¡¨å = $éƒ¨åˆ†[2];
            $è§†é¢‘ç´¢å¼• = $éƒ¨åˆ†[3];
            
            foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
                if (in_array($æ–‡ä»¶['type'], ['db', 'sqlite', 'sqlite3', 'db3']) && md5($æ–‡ä»¶['path']) === $æ–‡ä»¶å“ˆå¸Œ) {
                    return æŒ‰ç´¢å¼•æŸ¥æ‰¾æ•°æ®åº“è§†é¢‘($æ–‡ä»¶['path'], $è¡¨å, $è§†é¢‘ç´¢å¼•);
                }
            }
        }
    } elseif (strpos($æ ‡è¯†, 'json_') === 0) {
        // JSONæ•°æ®åº“çš„è§†é¢‘æŸ¥æ‰¾
        $éƒ¨åˆ† = explode('_', $æ ‡è¯†);
        if (count($éƒ¨åˆ†) >= 4) {
            $æ–‡ä»¶å“ˆå¸Œ = $éƒ¨åˆ†[1];
            $è¡¨å = $éƒ¨åˆ†[2];
            $è§†é¢‘ç´¢å¼• = $éƒ¨åˆ†[3];
            
            foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
                if (in_array($æ–‡ä»¶['type'], ['db', 'sqlite', 'sqlite3', 'db3']) && md5($æ–‡ä»¶['path']) === $æ–‡ä»¶å“ˆå¸Œ) {
                    return æŒ‰ç´¢å¼•æŸ¥æ‰¾æ•°æ®åº“è§†é¢‘($æ–‡ä»¶['path'], $è¡¨å, $è§†é¢‘ç´¢å¼•);
                }
            }
        }
    } elseif (strpos($æ ‡è¯†, 'live_') === 0) {
        // ç›´æ’­æ•°æ®åº“çš„è§†é¢‘æŸ¥æ‰¾
        $éƒ¨åˆ† = explode('_', $æ ‡è¯†);
        if (count($éƒ¨åˆ†) >= 4) {
            $æ–‡ä»¶å“ˆå¸Œ = $éƒ¨åˆ†[1];
            $è¡¨å = $éƒ¨åˆ†[2];
            $è§†é¢‘ç´¢å¼• = $éƒ¨åˆ†[3];
            
            foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
                if (in_array($æ–‡ä»¶['type'], ['db', 'sqlite', 'sqlite3', 'db3']) && md5($æ–‡ä»¶['path']) === $æ–‡ä»¶å“ˆå¸Œ) {
                    return æŒ‰ç´¢å¼•æŸ¥æ‰¾æ•°æ®åº“è§†é¢‘($æ–‡ä»¶['path'], $è¡¨å, $è§†é¢‘ç´¢å¼•);
                }
            }
        }
    } else {
        foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
            if ($æ–‡ä»¶['type'] === 'json') {
                $è§†é¢‘åˆ—è¡¨ = è§£æJSONæ–‡ä»¶($æ–‡ä»¶['path']);
                foreach ($è§†é¢‘åˆ—è¡¨ as $è§†é¢‘) {
                    if (isset($è§†é¢‘['vod_id']) && $è§†é¢‘['vod_id'] == $æ ‡è¯†) {
                        return $è§†é¢‘;
                    }
                }
            }
        }
    }
    
    return null;
}

/**
 * æŒ‰IDæŸ¥æ‰¾åˆ†ç±»è§†é¢‘
 */
function æŒ‰IDæŸ¥æ‰¾åˆ†ç±»è§†é¢‘($è§†é¢‘ID) {
    $æ‰€æœ‰æ–‡ä»¶ = è·å–æ‰€æœ‰æ–‡ä»¶();
    
    foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶) {
        if (in_array($æ–‡ä»¶['type'], ['db', 'sqlite', 'sqlite3', 'db3'])) {
            if (!file_exists($æ–‡ä»¶['path']) || !extension_loaded('pdo_sqlite')) {
                continue;
            }
            
            try {
                $æ•°æ®åº“ = new PDO("sqlite:" . $æ–‡ä»¶['path']);
                $æ•°æ®åº“->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘åˆ†ç±»æ•°æ®åº“
                $è¡¨åˆ—è¡¨ = $æ•°æ®åº“->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);
                
                if (in_array('videos', $è¡¨åˆ—è¡¨) && in_array('categories', $è¡¨åˆ—è¡¨)) {
                    // æŸ¥è¯¢æŒ‡å®šè§†é¢‘
                    $æŸ¥è¯¢SQL = "SELECT v.*, c.name as category_name FROM videos v LEFT JOIN categories c ON v.category_id = c.id WHERE v.id = ?";
                    $è¯­å¥ = $æ•°æ®åº“->prepare($æŸ¥è¯¢SQL);
                    $è¯­å¥->execute([$è§†é¢‘ID]);
                    $è§†é¢‘æ•°æ® = $è¯­å¥->fetch(PDO::FETCH_ASSOC);
                    
                    if ($è§†é¢‘æ•°æ®) {
                        $é»˜è®¤å›¾ç‰‡ = ['https://www.252035.xyz/imgs?t=1335527662'];
                        
                        $æ’­æ”¾æ¥æº = 'è§†é¢‘æº';
                        $æ’­æ”¾é“¾æ¥ = $è§†é¢‘æ•°æ®['play_url'] ?? '';
                        
                        if (strpos($æ’­æ”¾é“¾æ¥, 'magnet:') === 0) {
                            $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                        } elseif (strpos($æ’­æ”¾é“¾æ¥, 'ed2k://') === 0) {
                            $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
                        } elseif (strpos($æ’­æ”¾é“¾æ¥, 'http') === 0) {
                            $æ’­æ”¾æ¥æº = 'åœ¨çº¿æ’­æ”¾';
                        }
                        
                        $è§†é¢‘ = [
                            'vod_id' => 'video_' . $è§†é¢‘æ•°æ®['id'],
                            'vod_name' => $è§†é¢‘æ•°æ®['name'] ?? 'æœªçŸ¥è§†é¢‘',
                            'vod_pic' => $è§†é¢‘æ•°æ®['image'] ?? $é»˜è®¤å›¾ç‰‡[0],
                            'vod_remarks' => $è§†é¢‘æ•°æ®['remarks'] ?? 'é«˜æ¸…',
                            'vod_year' => $è§†é¢‘æ•°æ®['year'] ?? '',
                            'vod_area' => $è§†é¢‘æ•°æ®['area'] ?? 'ä¸­å›½å¤§é™†',
                            'vod_actor' => $è§†é¢‘æ•°æ®['actor'] ?? '',
                            'vod_director' => $è§†é¢‘æ•°æ®['director'] ?? '',
                            'vod_content' => $è§†é¢‘æ•°æ®['content'] ?? ($è§†é¢‘æ•°æ®['name'] ?? 'æœªçŸ¥è§†é¢‘') . 'çš„ç²¾å½©å†…å®¹',
                            'vod_play_from' => $æ’­æ”¾æ¥æº . ' Â· ' . ($è§†é¢‘æ•°æ®['category_name'] ?? 'æœªçŸ¥åˆ†ç±»'),
                            'vod_play_url' => 'æ­£ç‰‡$' . $æ’­æ”¾é“¾æ¥
                        ];
                        
                        $æ•°æ®åº“ = null;
                        return $è§†é¢‘;
                    }
                }
                
                $æ•°æ®åº“ = null;
            } catch (PDOException $å¼‚å¸¸) {
                continue;
            }
        }
    }
    
    return null;
}

/**
 * åœ¨TXTæ–‡ä»¶ä¸­æŒ‰è¡Œå·æŸ¥æ‰¾è§†é¢‘ - å¢å¼ºç£åŠ›é“¾æ¥æ”¯æŒ
 */
function æŒ‰è¡ŒæŸ¥æ‰¾TXTè§†é¢‘($æ–‡ä»¶è·¯å¾„, $ç›®æ ‡è¡Œå·) {
    if (!file_exists($æ–‡ä»¶è·¯å¾„)) {
        return null;
    }
    
    $å¥æŸ„ = @fopen($æ–‡ä»¶è·¯å¾„, 'r');
    if (!$å¥æŸ„) {
        return null;
    }
    
    $å½“å‰è¡Œ = 0;
    $è§†é¢‘ = null;
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662'
    ];
    
    $é¦–è¡Œ = fgets($å¥æŸ„);
    rewind($å¥æŸ„);
    $æœ‰BOM = (substr($é¦–è¡Œ, 0, 3) == "\xEF\xBB\xBF");
    if ($æœ‰BOM) {
        fseek($å¥æŸ„, 3);
    }
    
    while (($è¡Œ = fgets($å¥æŸ„)) !== false) {
        $å½“å‰è¡Œ++;
        $è¡Œ = trim($è¡Œ);
        
        if ($è¡Œ === '' || $è¡Œ[0] === '#' || $è¡Œ[0] === ';') continue;
        
        if ($å½“å‰è¡Œ == $ç›®æ ‡è¡Œå·) {
            if (strpos($è¡Œ, 'magnet:') === 0 || strpos($è¡Œ, 'ed2k://') === 0) {
                $é“¾æ¥ = $è¡Œ;
                $åç§° = ç”Ÿæˆè§†é¢‘åç§°($é“¾æ¥);
            } else {
                $åˆ†éš”ç¬¦ = [',', "\t", '|', '$', '#'];
                $åˆ†éš”ç¬¦ä½ç½® = false;
                
                foreach ($åˆ†éš”ç¬¦ as $åˆ†éš”) {
                    $ä½ç½® = strpos($è¡Œ, $åˆ†éš”);
                    if ($ä½ç½® !== false) {
                        $åˆ†éš”ç¬¦ä½ç½® = $ä½ç½®;
                        break;
                    }
                }
                
                if ($åˆ†éš”ç¬¦ä½ç½® !== false) {
                    $åç§° = trim(substr($è¡Œ, 0, $åˆ†éš”ç¬¦ä½ç½®));
                    $é“¾æ¥ = trim(substr($è¡Œ, $åˆ†éš”ç¬¦ä½ç½® + 1));
                } else {
                    $é“¾æ¥ = $è¡Œ;
                    $åç§° = ç”Ÿæˆè§†é¢‘åç§°($é“¾æ¥);
                }
            }
            
            if (!empty($åç§°) && !empty($é“¾æ¥)) {
                $å›¾ç‰‡ç´¢å¼• = $å½“å‰è¡Œ % count($é»˜è®¤å›¾ç‰‡);
                
                $æ’­æ”¾æ¥æº = 'åœ¨çº¿æ’­æ”¾';
                if (strpos($é“¾æ¥, 'magnet:') === 0) {
                    $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                } elseif (strpos($é“¾æ¥, 'ed2k://') === 0) {
                    $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
                }
                
                $è§†é¢‘ = [
                    'vod_id' => 'txt_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $å½“å‰è¡Œ,
                    'vod_name' => $åç§°,
                    'vod_pic' => $é»˜è®¤å›¾ç‰‡[$å›¾ç‰‡ç´¢å¼•],
                    'vod_remarks' => 'é«˜æ¸…',
                    'vod_year' => date('Y'),
                    'vod_area' => 'ä¸­å›½å¤§é™†',
                    'vod_content' => 'ã€Š' . $åç§° . 'ã€‹çš„ç²¾å½©å†…å®¹',
                    'vod_play_from' => $æ’­æ”¾æ¥æº,
                    'vod_play_url' => 'æ­£ç‰‡$' . $é“¾æ¥
                ];
            }
            break;
        }
    }
    
    fclose($å¥æŸ„);
    
    return $è§†é¢‘;
}

/**
 * åœ¨M3Uæ–‡ä»¶ä¸­æŒ‰è¡Œå·æŸ¥æ‰¾è§†é¢‘
 */
function æŒ‰è¡ŒæŸ¥æ‰¾M3Uè§†é¢‘($æ–‡ä»¶è·¯å¾„, $ç›®æ ‡è¡Œå·) {
    if (!file_exists($æ–‡ä»¶è·¯å¾„)) {
        return null;
    }
    
    $å¥æŸ„ = @fopen($æ–‡ä»¶è·¯å¾„, 'r');
    if (!$å¥æŸ„) {
        return null;
    }
    
    $å½“å‰è¡Œ = 0;
    $è§†é¢‘ = null;
    $å½“å‰åç§° = '';
    $å½“å‰å›¾æ ‡ = '';
    $å½“å‰åˆ†ç»„ = '';
    
    $é»˜è®¤å›¾ç‰‡ = [
        'https://www.252035.xyz/imgs?t=1335527662'
    ];
    
    $é¦–è¡Œ = fgets($å¥æŸ„);
    rewind($å¥æŸ„);
    $æœ‰BOM = (substr($é¦–è¡Œ, 0, 3) == "\xEF\xBB\xBF");
    if ($æœ‰BOM) {
        fseek($å¥æŸ„, 3);
    }
    
    while (($è¡Œ = fgets($å¥æŸ„)) !== false) {
        $å½“å‰è¡Œ++;
        $è¡Œ = trim($è¡Œ);
        if ($è¡Œ === '') continue;
        
        if (strpos($è¡Œ, '#EXTM3U') === 0) {
            continue;
        }
        
        if (strpos($è¡Œ, '#EXTINF:') === 0) {
            $å½“å‰åç§° = '';
            $å½“å‰å›¾æ ‡ = '';
            $å½“å‰åˆ†ç»„ = '';
            
            $éƒ¨åˆ† = explode(',', $è¡Œ, 2);
            if (count($éƒ¨åˆ†) > 1) {
                $å½“å‰åç§° = trim($éƒ¨åˆ†[1]);
            }
            
            if (preg_match('/tvg-logo="([^"]*)"/i', $è¡Œ, $å›¾æ ‡åŒ¹é…)) {
                $å½“å‰å›¾æ ‡ = trim($å›¾æ ‡åŒ¹é…[1]);
            }
            
            if (preg_match('/group-title="([^"]*)"/i', $è¡Œ, $åˆ†ç»„åŒ¹é…)) {
                $å½“å‰åˆ†ç»„ = trim($åˆ†ç»„åŒ¹é…[1]);
            }
            continue;
        }
        
        if ((strpos($è¡Œ, 'http') === 0 || strpos($è¡Œ, 'rtmp') === 0 || 
             strpos($è¡Œ, 'rtsp') === 0 || strpos($è¡Œ, 'udp') === 0 ||
             strpos($è¡Œ, 'magnet:') === 0 || strpos($è¡Œ, 'ed2k://') === 0) && 
            !empty($å½“å‰åç§°)) {
            
            if ($å½“å‰è¡Œ == $ç›®æ ‡è¡Œå·) {
                $å›¾ç‰‡ç´¢å¼• = $å½“å‰è¡Œ % count($é»˜è®¤å›¾ç‰‡);
                
                $è§†é¢‘å°é¢ = $å½“å‰å›¾æ ‡;
                if (empty($è§†é¢‘å°é¢) || !filter_var($è§†é¢‘å°é¢, FILTER_VALIDATE_URL)) {
                    $è§†é¢‘å°é¢ = $é»˜è®¤å›¾ç‰‡[$å›¾ç‰‡ç´¢å¼•];
                }
                
                $æ’­æ”¾æ¥æº = 'ç›´æ’­æº';
                if (!empty($å½“å‰åˆ†ç»„)) {
                    $æ’­æ”¾æ¥æº = $å½“å‰åˆ†ç»„;
                }
                
                if (strpos($è¡Œ, 'magnet:') === 0) {
                    $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
                } elseif (strpos($è¡Œ, 'ed2k://') === 0) {
                    $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
                }
                
                $è§†é¢‘ = [
                    'vod_id' => 'm3u_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $å½“å‰è¡Œ,
                    'vod_name' => $å½“å‰åç§°,
                    'vod_pic' => $è§†é¢‘å°é¢,
                    'vod_remarks' => 'ç›´æ’­',
                    'vod_year' => date('Y'),
                    'vod_area' => 'ä¸­å›½å¤§é™†',
                    'vod_content' => $å½“å‰åç§° . 'ç›´æ’­é¢‘é“',
                    'vod_play_from' => $æ’­æ”¾æ¥æº,
                    'vod_play_url' => 'ç›´æ’­$' . $è¡Œ
                ];
                break;
            }
            
            $å½“å‰åç§° = '';
            $å½“å‰å›¾æ ‡ = '';
            $å½“å‰åˆ†ç»„ = '';
        }
    }
    
    fclose($å¥æŸ„);
    
    return $è§†é¢‘;
}

/**
 * åœ¨æ•°æ®åº“æ–‡ä»¶ä¸­æŒ‰ç´¢å¼•æŸ¥æ‰¾è§†é¢‘ - å¢å¼ºç£åŠ›é“¾æ¥æ”¯æŒ
 */
function æŒ‰ç´¢å¼•æŸ¥æ‰¾æ•°æ®åº“è§†é¢‘($æ–‡ä»¶è·¯å¾„, $è¡¨å, $è§†é¢‘ç´¢å¼•) {
    if (!file_exists($æ–‡ä»¶è·¯å¾„) || !extension_loaded('pdo_sqlite')) {
        return null;
    }
    
    try {
        $æ•°æ®åº“ = new PDO("sqlite:" . $æ–‡ä»¶è·¯å¾„);
        $æ•°æ®åº“->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // æŸ¥è¯¢æŒ‡å®šè¡Œçš„dataå­—æ®µ
        $æŸ¥è¯¢SQL = "SELECT * FROM $è¡¨å LIMIT 1 OFFSET " . intval($è§†é¢‘ç´¢å¼•);
        $è¯­å¥ = $æ•°æ®åº“->query($æŸ¥è¯¢SQL);
        $è¡Œæ•°æ® = $è¯­å¥->fetch(PDO::FETCH_ASSOC);
        
        if ($è¡Œæ•°æ®) {
            $é»˜è®¤å›¾ç‰‡ = ['https://www.252035.xyz/imgs?t=1335527662'];
            
            // å°è¯•å¤šç§å­—æ®µç»„åˆ
            $è§†é¢‘åç§° = $è¡Œæ•°æ®['name'] ?? $è¡Œæ•°æ®['title'] ?? $è¡Œæ•°æ®['vod_name'] ?? 'æœªçŸ¥è§†é¢‘';
            $è§†é¢‘é“¾æ¥ = $è¡Œæ•°æ®['magnet'] ?? $è¡Œæ•°æ®['url'] ?? $è¡Œæ•°æ®['link'] ?? $è¡Œæ•°æ®['play_url'] ?? '';
            $æ’­æ”¾æ¥æº = 'æ•°æ®åº“æº';
            
            if (strpos($è§†é¢‘é“¾æ¥, 'magnet:') === 0) {
                $æ’­æ”¾æ¥æº = 'ğŸ§²ç£åŠ›é“¾æ¥';
            } elseif (strpos($è§†é¢‘é“¾æ¥, 'ed2k://') === 0) {
                $æ’­æ”¾æ¥æº = 'âš¡ç”µé©´é“¾æ¥';
            }
            
            if (empty($è§†é¢‘é“¾æ¥)) {
                $æ•°æ®åº“ = null;
                return null;
            }
            
            $è§†é¢‘å°é¢ = $è¡Œæ•°æ®['image'] ?? $è¡Œæ•°æ®['pic'] ?? $è¡Œæ•°æ®['cover'] ?? $è¡Œæ•°æ®['vod_pic'] ?? $é»˜è®¤å›¾ç‰‡[intval($è§†é¢‘ç´¢å¼•) % count($é»˜è®¤å›¾ç‰‡)];
            $è§†é¢‘æè¿° = $è¡Œæ•°æ®['content'] ?? $è¡Œæ•°æ®['desc'] ?? $è¡Œæ•°æ®['description'] ?? $è¡Œæ•°æ®['vod_content'] ?? $è§†é¢‘åç§° . 'çš„ç²¾å½©å†…å®¹';
            $è§†é¢‘å¹´ä»½ = $è¡Œæ•°æ®['year'] ?? $è¡Œæ•°æ®['vod_year'] ?? date('Y');
            $è§†é¢‘åœ°åŒº = $è¡Œæ•°æ®['area'] ?? $è¡Œæ•°æ®['region'] ?? $è¡Œæ•°æ®['vod_area'] ?? 'ä¸­å›½å¤§é™†';
            
            $è§†é¢‘ = [
                'vod_id' => 'db_' . md5($æ–‡ä»¶è·¯å¾„) . '_' . $è¡¨å . '_' . $è§†é¢‘ç´¢å¼•,
                'vod_name' => $è§†é¢‘åç§°,
                'vod_pic' => $è§†é¢‘å°é¢,
                'vod_remarks' => 'é«˜æ¸…',
                'vod_year' => $è§†é¢‘å¹´ä»½,
                'vod_area' => $è§†é¢‘åœ°åŒº,
                'vod_content' => $è§†é¢‘æè¿°,
                'vod_play_from' => $æ’­æ”¾æ¥æº,
                'vod_play_url' => 'æ­£ç‰‡$' . $è§†é¢‘é“¾æ¥
            ];
            
            $æ•°æ®åº“ = null;
            return $è§†é¢‘;
        }
        
        $æ•°æ®åº“ = null;
        return null;
        
    } catch (PDOException $å¼‚å¸¸) {
        return null;
    }
}
/**
 * æ™ºèƒ½æœç´¢åŒ¹é…å‡½æ•°
 */
function æœç´¢åŒ¹é…($æ–‡æœ¬, $å…³é”®è¯) {
    if (empty($æ–‡æœ¬) || empty($å…³é”®è¯)) {
        return false;
    }
    
    $æ–‡æœ¬ = strtolower(trim($æ–‡æœ¬));
    $å…³é”®è¯ = strtolower(trim($å…³é”®è¯));
    
    // å®Œå…¨åŒ¹é…
    if (strpos($æ–‡æœ¬, $å…³é”®è¯) !== false) {
        return true;
    }
    
    // ä¸­æ–‡åˆ†è¯åŒ¹é…ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
    $å…³é”®è¯é•¿åº¦ = mb_strlen($å…³é”®è¯, 'UTF-8');
    if ($å…³é”®è¯é•¿åº¦ > 1) {
        // å¯¹é•¿å…³é”®è¯è¿›è¡Œåˆ†è¯åŒ¹é…
        for ($i = 0; $i < $å…³é”®è¯é•¿åº¦; $i++) {
            $å­—ç¬¦ = mb_substr($å…³é”®è¯, $i, 1, 'UTF-8');
            if (mb_strpos($æ–‡æœ¬, $å­—ç¬¦, 0, 'UTF-8') === false) {
                return false;
            }
        }
        return true;
    }
    
    return false;
}

/**
 * æœç´¢ - ä¿®å¤ç‰ˆ
 */
function æœç´¢($å…³é”®è¯, $é¡µç ) {
    if (empty($å…³é”®è¯)) {
        return ['é”™è¯¯' => 'è¯·è¾“å…¥æœç´¢å…³é”®è¯'];
    }
    
    $æœç´¢ç»“æœ = [];
    $æ‰€æœ‰æ–‡ä»¶ = è·å–æ‰€æœ‰æ–‡ä»¶();
    
    // æ”¾å®½æœç´¢é™åˆ¶ï¼Œå¢åŠ æœç´¢æ–‡ä»¶æ•°é‡
    $æœç´¢é™åˆ¶ = 10; // ä»3å¢åŠ åˆ°10
    $å·²æœç´¢æ–‡ä»¶ = 0;
    
    // è®°å½•æœç´¢è¿‡ç¨‹ç”¨äºè°ƒè¯•
    $æœç´¢æ—¥å¿— = [];
    
    foreach ($æ‰€æœ‰æ–‡ä»¶ as $æ–‡ä»¶ç´¢å¼• => $æ–‡ä»¶) {
        if ($å·²æœç´¢æ–‡ä»¶ >= $æœç´¢é™åˆ¶) {
            break;
        }
        
        $æœç´¢æ—¥å¿—[] = "æœç´¢æ–‡ä»¶: " . $æ–‡ä»¶['name'] . " (ç±»å‹: " . $æ–‡ä»¶['type'] . ")";
        
        // è·³è¿‡å¯èƒ½çš„å¤§æ–‡ä»¶æˆ–é—®é¢˜æ–‡ä»¶
        if (!file_exists($æ–‡ä»¶['path'])) {
            $æœç´¢æ—¥å¿—[] = "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡";
            continue;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œé¿å…å¤„ç†è¿‡å¤§æ–‡ä»¶
        $æ–‡ä»¶å¤§å° = filesize($æ–‡ä»¶['path']);
        if ($æ–‡ä»¶å¤§å° > 10 * 1024 * 1024) { // è¶…è¿‡10MBè·³è¿‡
            $æœç´¢æ—¥å¿—[] = "æ–‡ä»¶è¿‡å¤§(" . round($æ–‡ä»¶å¤§å°/1024/1024, 2) . "MB)ï¼Œè·³è¿‡";
            continue;
        }
        
        $è§†é¢‘åˆ—è¡¨ = [];
        try {
            switch ($æ–‡ä»¶['type']) {
                case 'json':
                    $è§†é¢‘åˆ—è¡¨ = è§£æJSONæ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                case 'txt':
                    $è§†é¢‘åˆ—è¡¨ = è§£æTXTæ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                case 'm3u':
                    $è§†é¢‘åˆ—è¡¨ = è§£æM3Uæ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                case 'db':
                case 'sqlite':
                case 'sqlite3':
                case 'db3':
                    $è§†é¢‘åˆ—è¡¨ = è§£ææ•°æ®åº“æ–‡ä»¶($æ–‡ä»¶['path']);
                    break;
                default:
                    continue 2; // è·³è¿‡æœªçŸ¥ç±»å‹
            }
        } catch (Exception $e) {
            $æœç´¢æ—¥å¿—[] = "æ–‡ä»¶è§£æå¤±è´¥: " . $e->getMessage();
            continue;
        }
        
        // æ£€æŸ¥è§£æç»“æœ
        if (isset($è§†é¢‘åˆ—è¡¨['é”™è¯¯'])) {
            $æœç´¢æ—¥å¿—[] = "è§£æé”™è¯¯: " . $è§†é¢‘åˆ—è¡¨['é”™è¯¯'];
            continue;
        }
        
        if (!is_array($è§†é¢‘åˆ—è¡¨) || empty($è§†é¢‘åˆ—è¡¨)) {
            $æœç´¢æ—¥å¿—[] = "æ— è§†é¢‘æ•°æ®";
            continue;
        }
        
        $æ–‡ä»¶åŒ¹é…æ•° = 0;
        foreach ($è§†é¢‘åˆ—è¡¨ as $è§†é¢‘ç´¢å¼• => $è§†é¢‘) {
            // æ›´å®½æ¾çš„åŒ¹é…æ¡ä»¶
            $è§†é¢‘åç§° = $è§†é¢‘['vod_name'] ?? '';
            if (empty($è§†é¢‘åç§°)) {
                continue;
            }
            
            // ä½¿ç”¨æ›´æ™ºèƒ½çš„æœç´¢åŒ¹é…
            if (æœç´¢åŒ¹é…($è§†é¢‘åç§°, $å…³é”®è¯)) {
                $æ ¼å¼åŒ–è§†é¢‘ = æ ¼å¼åŒ–è§†é¢‘é¡¹($è§†é¢‘);
                $æœç´¢ç»“æœ[] = $æ ¼å¼åŒ–è§†é¢‘;
                $æ–‡ä»¶åŒ¹é…æ•°++;
                
                // é™åˆ¶å•ä¸ªæ–‡ä»¶çš„æœç´¢ç»“æœæ•°é‡
                if ($æ–‡ä»¶åŒ¹é…æ•° >= 20) {
                    break;
                }
                
                // æ€»ç»“æœæ•°é‡é™åˆ¶
                if (count($æœç´¢ç»“æœ) >= 50) {
                    break 2;
                }
            }
        }
        
        $æœç´¢æ—¥å¿—[] = "åœ¨æœ¬æ–‡ä»¶æ‰¾åˆ° " . $æ–‡ä»¶åŒ¹é…æ•° . " ä¸ªåŒ¹é…ç»“æœ";
        $å·²æœç´¢æ–‡ä»¶++;
    }
    
    // å¦‚æœæ²¡æœ‰ç»“æœï¼Œè¿”å›è°ƒè¯•ä¿¡æ¯
    if (empty($æœç´¢ç»“æœ)) {
        return [
            'é”™è¯¯' => 'æœªæ‰¾åˆ°ç›¸å…³è§†é¢‘å†…å®¹',
            'è°ƒè¯•ä¿¡æ¯' => [
                'å…³é”®è¯' => $å…³é”®è¯,
                'æœç´¢æ–‡ä»¶æ•°' => $å·²æœç´¢æ–‡ä»¶,
                'æ€»æ–‡ä»¶æ•°' => count($æ‰€æœ‰æ–‡ä»¶),
                'æœç´¢æ—¥å¿—' => $æœç´¢æ—¥å¿—
            ]
        ];
    }
    
    // å»é‡ç»“æœ
    $å»é‡ç»“æœ = [];
    $å·²å­˜åœ¨æ ‡è¯† = [];
    foreach ($æœç´¢ç»“æœ as $è§†é¢‘) {
        $è§†é¢‘æ ‡è¯† = $è§†é¢‘['vod_id'] ?? $è§†é¢‘['vod_name'];
        if (!in_array($è§†é¢‘æ ‡è¯†, $å·²å­˜åœ¨æ ‡è¯†)) {
            $å»é‡ç»“æœ[] = $è§†é¢‘;
            $å·²å­˜åœ¨æ ‡è¯†[] = $è§†é¢‘æ ‡è¯†;
        }
    }
    $æœç´¢ç»“æœ = $å»é‡ç»“æœ;
    
    // åˆ†é¡µå¤„ç†
    $æ¯é¡µå¤§å° = 10;
    $æ€»æ•° = count($æœç´¢ç»“æœ);
    $æ€»é¡µæ•° = ceil($æ€»æ•° / $æ¯é¡µå¤§å°);
    $å½“å‰é¡µç  = intval($é¡µç );
    
    if ($å½“å‰é¡µç  < 1) $å½“å‰é¡µç  = 1;
    if ($å½“å‰é¡µç  > $æ€»é¡µæ•°) $å½“å‰é¡µç  = $æ€»é¡µæ•°;
    
    $èµ·å§‹ä½ç½® = ($å½“å‰é¡µç  - 1) * $æ¯é¡µå¤§å°;
    $åˆ†é¡µç»“æœ = array_slice($æœç´¢ç»“æœ, $èµ·å§‹ä½ç½®, $æ¯é¡µå¤§å°);
    
    return [
        'page' => $å½“å‰é¡µç ,
        'pagecount' => $æ€»é¡µæ•°,
        'limit' => $æ¯é¡µå¤§å°,
        'total' => $æ€»æ•°,
        'list' => $åˆ†é¡µç»“æœ
    ];
}

/**
 * æ ¼å¼åŒ–è§†é¢‘è¯¦æƒ…
 */
function æ ¼å¼åŒ–è§†é¢‘è¯¦æƒ…($è§†é¢‘) {
    return [
        'vod_id' => $è§†é¢‘['vod_id'] ?? '',
        'vod_name' => $è§†é¢‘['vod_name'] ?? 'æœªçŸ¥è§†é¢‘',
        'vod_pic' => $è§†é¢‘['vod_pic'] ?? 'https://www.252035.xyz/imgs?t=1335527662',
        'vod_remarks' => $è§†é¢‘['vod_remarks'] ?? 'é«˜æ¸…',
        'vod_year' => $è§†é¢‘['vod_year'] ?? '',
        'vod_area' => $è§†é¢‘['vod_area'] ?? 'ä¸­å›½å¤§é™†',
        'vod_director' => $è§†é¢‘['vod_director'] ?? '',
        'vod_actor' => $è§†é¢‘['vod_actor'] ?? '',
        'vod_content' => $è§†é¢‘['vod_content'] ?? 'è§†é¢‘è¯¦æƒ…å†…å®¹',
        'vod_play_from' => $è§†é¢‘['vod_play_from'] ?? 'default',
        'vod_play_url' => $è§†é¢‘['vod_play_url'] ?? ''
    ];
}

/**
 * è·å–æ’­æ”¾åœ°å€ - å¢å¼ºç£åŠ›é“¾æ¥æ”¯æŒ
 */
function è·å–æ’­æ”¾($æ ‡å¿—, $æ ‡è¯†) {
    // è§£ç URLå‚æ•°
    $æ’­æ”¾æ ‡è¯† = urldecode($æ ‡è¯†);
    
    // ç›´æ¥è¿”å›æ’­æ”¾åœ°å€ï¼ŒTVBoxæ’­æ”¾å™¨ä¼šå¤„ç†ç£åŠ›é“¾æ¥
    return [
        'parse' => 0, // 0è¡¨ç¤ºä¸è§£æï¼Œç›´æ¥æ’­æ”¾
        'playUrl' => '',
        'url' => $æ’­æ”¾æ ‡è¯†,
        'header' => [
            'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        ],
        'type' => 'video'
    ];
}
?>